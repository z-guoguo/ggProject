{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar d3Force = __importStar(require(\"d3-force\"));\n\nvar forceGrid_1 = __importDefault(require(\"./forceGrid\"));\n\nvar mysqlWorkbench_1 = __importDefault(require(\"./mysqlWorkbench\"));\n\nvar dagre_1 = require(\"../dagre\");\n\nfunction layout(data, options) {\n  var nodes = data.nodes,\n      edges = data.edges;\n  var width = options.width;\n  var height = options.height;\n  if (!(nodes === null || nodes === void 0 ? void 0 : nodes.length)) return Promise.resolve(); // 筛选非叶子节点，做Dagre布局\n\n  var noLeafNodes = [];\n  nodes.forEach(function (node) {\n    var relateEdges = edges.filter(function (edge) {\n      return edge.source === node.id || edge.target === node.id;\n    });\n\n    if (relateEdges.length > 1) {\n      var temp = __assign({}, node);\n\n      delete temp.size;\n      noLeafNodes.push(temp);\n    }\n  });\n  var noLeafEdge = [];\n  edges.forEach(function (edge) {\n    var sourceNode = noLeafNodes.find(function (node) {\n      return node.id === edge.source;\n    });\n    var targetNode = noLeafNodes.find(function (node) {\n      return node.id === edge.target;\n    });\n\n    if (sourceNode && targetNode) {\n      noLeafEdge.push(edge);\n    }\n  });\n  var graphLayout = new dagre_1.DagreLayout({\n    type: 'dagre',\n    ranksep: options.nodeMinGap,\n    nodesep: options.nodeMinGap\n  });\n  var nodesTmp = graphLayout.layout({\n    nodes: noLeafNodes,\n    edges: noLeafEdge\n  }).nodes; // 布局后，坐标同步\n\n  nodes.forEach(function (n) {\n    var found = (nodesTmp || []).find(function (temp) {\n      return temp.id === n.id;\n    });\n    n.x = (found === null || found === void 0 ? void 0 : found.x) || width / 2;\n    n.y = (found === null || found === void 0 ? void 0 : found.y) || height / 2;\n  });\n  var copyNodes = JSON.parse(JSON.stringify(nodes));\n  var copyEdges = JSON.parse(JSON.stringify(edges));\n  var simulation = d3Force.forceSimulation().nodes(copyNodes).force(\"link\", d3Force.forceLink(copyEdges).id(function (d) {\n    return d.id;\n  }).distance(function (d) {\n    var edgeInfo = noLeafEdge.find(function (edge) {\n      return edge.source === d.source && edge.target === d.target;\n    });\n\n    if (edgeInfo) {\n      return 30;\n    }\n\n    return 20;\n  })).force(\"charge\", d3Force.forceManyBody()).force(\"center\", d3Force.forceCenter(width / 2, height / 2)).force(\"x\", d3Force.forceX(width / 2)).force(\"y\", d3Force.forceY(height / 2)).alpha(0.3).alphaDecay(0.08).alphaMin(0.001);\n  var layoutPromise = new Promise(function (resolve) {\n    simulation.on('end', function () {\n      // 坐标信息同步到nodes,edges中\n      nodes.forEach(function (node) {\n        var nodeInfo = copyNodes.find(function (item) {\n          return item.id === node.id;\n        });\n\n        if (nodeInfo) {\n          node.x = nodeInfo.x;\n          node.y = nodeInfo.y;\n        }\n      });\n      var minX = Math.min.apply(Math, nodes.map(function (node) {\n        return node.x;\n      }));\n      var maxX = Math.max.apply(Math, nodes.map(function (node) {\n        return node.x;\n      }));\n      var minY = Math.min.apply(Math, nodes.map(function (node) {\n        return node.y;\n      }));\n      var maxY = Math.max.apply(Math, nodes.map(function (node) {\n        return node.y;\n      }));\n      var scalex = width / (maxX - minX);\n      var scaley = height / (maxY - minY);\n      nodes.forEach(function (node) {\n        if (node.x !== undefined && scalex < 1) {\n          node.x = (node.x - minX) * scalex;\n        }\n\n        if (node.y !== undefined && scaley < 1) {\n          node.y = (node.y - minY) * scaley;\n        }\n      }); // 这一步就执行缩小空间。且不考虑节点size\n\n      nodes.forEach(function (node) {\n        node.sizeTemp = node.size;\n        node.size = [10, 10];\n      });\n      (0, mysqlWorkbench_1.default)(nodes, edges);\n      nodes.forEach(function (node) {\n        node.size = node.sizeTemp || [];\n        delete node.sizeTemp;\n      }); // 进行网格对齐+节点大小扩增\n\n      (0, forceGrid_1.default)({\n        nodes: nodes,\n        edges: edges\n      }, options);\n      resolve();\n    });\n  });\n  return layoutPromise;\n}\n\nexports.default = layout;","map":{"version":3,"mappings":"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","names":["layout","data","options","edges","width","height","nodes","length","Promise","resolve","noLeafNodes","forEach","node","relateEdges","filter","edge","source","id","target","temp","size","push","noLeafEdge","sourceNode","find","targetNode","graphLayout","dagre_1","type","ranksep","nodeMinGap","nodesep","nodesTmp","n","found","x","y","copyNodes","JSON","parse","stringify","copyEdges","simulation","d3Force","forceSimulation","force","forceLink","d","distance","edgeInfo","forceManyBody","forceCenter","forceX","forceY","alpha","alphaDecay","alphaMin","layoutPromise","on","nodeInfo","item","minX","Math","min","apply","map","maxX","max","minY","maxY","scalex","scaley","undefined","sizeTemp","exports"],"sourceRoot":"","sources":["../../../src/layout/er/core.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}