{"ast":null,"code":"import \"core-js/modules/web.dom-exception.stack.js\";\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nimport * as Registry from '../registry';\nimport { Dom, Vector } from '../util';\nimport { Base } from './base';\nexport class GridManager extends Base {\n  get elem() {\n    return this.view.grid;\n  }\n\n  get grid() {\n    return this.options.grid;\n  }\n\n  init() {\n    this.startListening();\n    this.draw(this.grid);\n  }\n\n  startListening() {\n    this.graph.on('scale', this.update, this);\n    this.graph.on('translate', this.update, this);\n  }\n\n  stopListening() {\n    this.graph.off('scale', this.update, this);\n    this.graph.off('translate', this.update, this);\n  }\n\n  setVisible(visible) {\n    if (this.grid.visible !== visible) {\n      this.grid.visible = visible;\n      this.update();\n    }\n  }\n\n  getGridSize() {\n    return this.grid.size;\n  }\n\n  setGridSize(size) {\n    this.grid.size = Math.max(size, 1);\n    this.update();\n  }\n\n  show() {\n    this.setVisible(true);\n    this.update();\n  }\n\n  hide() {\n    this.setVisible(false);\n    this.update();\n  }\n\n  clear() {\n    this.elem.style.backgroundImage = '';\n  }\n\n  draw(options) {\n    this.clear();\n    this.instance = null;\n    Object.assign(this.grid, options);\n    this.patterns = this.resolveGrid(options);\n    this.update();\n  }\n\n  update(options = {}) {\n    const gridSize = this.grid.size;\n\n    if (gridSize <= 1 || !this.grid.visible) {\n      return this.clear();\n    }\n\n    const ctm = this.graph.matrix();\n    const grid = this.getInstance();\n    const items = Array.isArray(options) ? options : [options];\n    this.patterns.forEach((settings, index) => {\n      const id = `pattern_${index}`;\n      const sx = ctm.a || 1;\n      const sy = ctm.d || 1;\n\n      const {\n        update,\n        markup\n      } = settings,\n            others = __rest(settings, [\"update\", \"markup\"]);\n\n      const options = Object.assign(Object.assign(Object.assign({}, others), items[index]), {\n        sx,\n        sy,\n        ox: ctm.e || 0,\n        oy: ctm.f || 0,\n        width: gridSize * sx,\n        height: gridSize * sy\n      });\n\n      if (!grid.has(id)) {\n        grid.add(id, Vector.create('pattern', {\n          id,\n          patternUnits: 'userSpaceOnUse'\n        }, Vector.createVectors(markup)).node);\n      }\n\n      const patternElem = grid.get(id);\n\n      if (typeof update === 'function') {\n        update(patternElem.childNodes[0], options);\n      }\n\n      let x = options.ox % options.width;\n\n      if (x < 0) {\n        x += options.width;\n      }\n\n      let y = options.oy % options.height;\n\n      if (y < 0) {\n        y += options.height;\n      }\n\n      Dom.attr(patternElem, {\n        x,\n        y,\n        width: options.width,\n        height: options.height\n      });\n    });\n    const base64 = new XMLSerializer().serializeToString(grid.root);\n    const url = `url(data:image/svg+xml;base64,${btoa(base64)})`;\n    this.elem.style.backgroundImage = url;\n  }\n\n  getInstance() {\n    if (!this.instance) {\n      this.instance = new Registry.Grid();\n    }\n\n    return this.instance;\n  }\n\n  resolveGrid(options) {\n    if (!options) {\n      return [];\n    }\n\n    const type = options.type;\n\n    if (type == null) {\n      return [Object.assign(Object.assign({}, Registry.Grid.presets.dot), options.args)];\n    }\n\n    const items = Registry.Grid.registry.get(type);\n\n    if (items) {\n      let args = options.args || [];\n\n      if (!Array.isArray(args)) {\n        args = [args];\n      }\n\n      return Array.isArray(items) ? items.map((item, index) => Object.assign(Object.assign({}, item), args[index])) : [Object.assign(Object.assign({}, items), args[0])];\n    }\n\n    return Registry.Grid.registry.onNotFound(type);\n  }\n\n  dispose() {\n    this.stopListening();\n    this.clear();\n  }\n\n}\n\n__decorate([Base.dispose()], GridManager.prototype, \"dispose\", null);","map":{"version":3,"mappings":"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","names":["Registry","Dom","Vector","Base","GridManager","elem","view","grid","options","init","startListening","draw","graph","on","update","stopListening","off","setVisible","visible","getGridSize","size","setGridSize","Math","max","show","hide","clear","style","backgroundImage","instance","Object","assign","patterns","resolveGrid","gridSize","ctm","matrix","getInstance","items","Array","isArray","forEach","settings","index","id","sx","a","sy","d","markup","others","ox","e","oy","f","width","height","has","add","create","patternUnits","createVectors","node","patternElem","get","childNodes","x","y","attr","base64","XMLSerializer","serializeToString","root","url","btoa","Grid","type","presets","dot","args","registry","map","item","onNotFound","dispose","__decorate"],"sourceRoot":"","sources":["../../src/graph/grid.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}