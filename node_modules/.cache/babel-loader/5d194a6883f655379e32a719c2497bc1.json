{"ast":null,"code":"import { __assign, __extends } from \"tslib\";\nimport { Line as LineUtil } from '@antv/g-math';\nimport { Polyline as PolylineUtil } from '@antv/g-math';\nimport { each, isNil } from '@antv/util';\nimport ShapeBase from './base';\nimport inPolyline from '../util/in-stroke/polyline';\nimport * as ArrowUtil from '../util/arrow';\n\nvar PolyLine =\n/** @class */\nfunction (_super) {\n  __extends(PolyLine, _super);\n\n  function PolyLine() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  PolyLine.prototype.getDefaultAttrs = function () {\n    var attrs = _super.prototype.getDefaultAttrs.call(this);\n\n    return __assign(__assign({}, attrs), {\n      startArrow: false,\n      endArrow: false\n    });\n  };\n\n  PolyLine.prototype.initAttrs = function (attrs) {\n    this.setArrow();\n  }; // 更新属性时，检测是否更改了 points\n\n\n  PolyLine.prototype.onAttrChange = function (name, value, originValue) {\n    _super.prototype.onAttrChange.call(this, name, value, originValue);\n\n    this.setArrow();\n\n    if (['points'].indexOf(name) !== -1) {\n      this._resetCache();\n    }\n  };\n\n  PolyLine.prototype._resetCache = function () {\n    this.set('totalLength', null);\n    this.set('tCache', null);\n  };\n\n  PolyLine.prototype.setArrow = function () {\n    var attrs = this.attr();\n    var _a = this.attrs,\n        points = _a.points,\n        startArrow = _a.startArrow,\n        endArrow = _a.endArrow;\n    var length = points.length;\n    var x1 = points[0][0];\n    var y1 = points[0][1];\n    var x2 = points[length - 1][0];\n    var y2 = points[length - 1][1];\n\n    if (startArrow) {\n      ArrowUtil.addStartArrow(this, attrs, points[1][0], points[1][1], x1, y1);\n    }\n\n    if (endArrow) {\n      ArrowUtil.addEndArrow(this, attrs, points[length - 2][0], points[length - 2][1], x2, y2);\n    }\n  }; // 不允许 fill\n\n\n  PolyLine.prototype.isFill = function () {\n    return false;\n  };\n\n  PolyLine.prototype.isInStrokeOrPath = function (x, y, isStroke, isFill, lineWidth) {\n    // 没有设置 stroke 不能被拾取, 没有线宽不能被拾取\n    if (!isStroke || !lineWidth) {\n      return false;\n    }\n\n    var points = this.attr().points;\n    return inPolyline(points, lineWidth, x, y, false);\n  }; // 始终填充\n\n\n  PolyLine.prototype.isStroke = function () {\n    return true;\n  };\n\n  PolyLine.prototype.createPath = function (context) {\n    var _a = this.attr(),\n        points = _a.points,\n        startArrow = _a.startArrow,\n        endArrow = _a.endArrow;\n\n    var length = points.length;\n\n    if (points.length < 2) {\n      return;\n    }\n\n    var x1 = points[0][0];\n    var y1 = points[0][1];\n    var x2 = points[length - 1][0];\n    var y2 = points[length - 1][1]; // 如果定义了箭头，并且是自定义箭头，线条相应缩进\n\n    if (startArrow && startArrow.d) {\n      var distance = ArrowUtil.getShortenOffset(x1, y1, points[1][0], points[1][1], startArrow.d);\n      x1 += distance.dx;\n      y1 += distance.dy;\n    }\n\n    if (endArrow && endArrow.d) {\n      var distance = ArrowUtil.getShortenOffset(points[length - 2][0], points[length - 2][1], x2, y2, endArrow.d);\n      x2 -= distance.dx;\n      y2 -= distance.dy;\n    }\n\n    context.beginPath();\n    context.moveTo(x1, y1);\n\n    for (var i = 0; i < length - 1; i++) {\n      var point = points[i];\n      context.lineTo(point[0], point[1]);\n    }\n\n    context.lineTo(x2, y2);\n  };\n\n  PolyLine.prototype.afterDrawPath = function (context) {\n    var startArrowShape = this.get('startArrowShape');\n    var endArrowShape = this.get('endArrowShape');\n\n    if (startArrowShape) {\n      startArrowShape.draw(context);\n    }\n\n    if (endArrowShape) {\n      endArrowShape.draw(context);\n    }\n  };\n  /**\n   * Get length of polyline\n   * @return {number} length\n   */\n\n\n  PolyLine.prototype.getTotalLength = function () {\n    var points = this.attr().points; // get totalLength from cache\n\n    var totalLength = this.get('totalLength');\n\n    if (!isNil(totalLength)) {\n      return totalLength;\n    }\n\n    this.set('totalLength', PolylineUtil.length(points));\n    return this.get('totalLength');\n  };\n  /**\n   * Get point according to ratio\n   * @param {number} ratio\n   * @return {Point} point\n   */\n\n\n  PolyLine.prototype.getPoint = function (ratio) {\n    var points = this.attr().points; // get tCache from cache\n\n    var tCache = this.get('tCache');\n\n    if (!tCache) {\n      this._setTcache();\n\n      tCache = this.get('tCache');\n    }\n\n    var subt;\n    var index;\n    each(tCache, function (v, i) {\n      if (ratio >= v[0] && ratio <= v[1]) {\n        subt = (ratio - v[0]) / (v[1] - v[0]);\n        index = i;\n      }\n    });\n    return LineUtil.pointAt(points[index][0], points[index][1], points[index + 1][0], points[index + 1][1], subt);\n  };\n\n  PolyLine.prototype._setTcache = function () {\n    var points = this.attr().points;\n\n    if (!points || points.length === 0) {\n      return;\n    }\n\n    var totalLength = this.getTotalLength();\n\n    if (totalLength <= 0) {\n      return;\n    }\n\n    var tempLength = 0;\n    var tCache = [];\n    var segmentT;\n    var segmentL;\n    each(points, function (p, i) {\n      if (points[i + 1]) {\n        segmentT = [];\n        segmentT[0] = tempLength / totalLength;\n        segmentL = LineUtil.length(p[0], p[1], points[i + 1][0], points[i + 1][1]);\n        tempLength += segmentL;\n        segmentT[1] = tempLength / totalLength;\n        tCache.push(segmentT);\n      }\n    });\n    this.set('tCache', tCache);\n  };\n  /**\n   * Get start tangent vector\n   * @return {Array}\n   */\n\n\n  PolyLine.prototype.getStartTangent = function () {\n    var points = this.attr().points;\n    var result = [];\n    result.push([points[1][0], points[1][1]]);\n    result.push([points[0][0], points[0][1]]);\n    return result;\n  };\n  /**\n   * Get end tangent vector\n   * @return {Array}\n   */\n\n\n  PolyLine.prototype.getEndTangent = function () {\n    var points = this.attr().points;\n    var l = points.length - 1;\n    var result = [];\n    result.push([points[l - 1][0], points[l - 1][1]]);\n    result.push([points[l][0], points[l][1]]);\n    return result;\n  };\n\n  return PolyLine;\n}(ShapeBase);\n\nexport default PolyLine;","map":{"version":3,"mappings":"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","names":["Line","LineUtil","Polyline","PolylineUtil","each","isNil","ShapeBase","inPolyline","ArrowUtil","__extends","PolyLine","attrs","_super","getDefaultAttrs","call","startArrow","endArrow","setArrow","name","value","originValue","onAttrChange","indexOf","_resetCache","set","attr","points","length","x1","y1","x2","y2","addStartArrow","addEndArrow","x","y","isStroke","isFill","lineWidth","context","d","distance","getShortenOffset","dx","dy","beginPath","moveTo","i","point","lineTo","startArrowShape","get","endArrowShape","draw","totalLength","ratio","tCache","_setTcache","subt","index","v","pointAt","getTotalLength","tempLength","segmentT","segmentL","p","push","result","l"],"sourceRoot":"","sources":["../../src/shape/polyline.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}