{"ast":null,"code":"import { ObjectExt, FunctionExt } from '../../util';\nimport { Rectangle } from '../../geometry';\nimport { Widget, Handle } from '../common';\nimport { NodePreset } from './node-preset';\nimport { EdgePreset } from './edge-preset';\nexport class Halo extends Widget {\n  get type() {\n    return this.options.type || 'surround';\n  }\n\n  get handleOptions() {\n    return this.options;\n  }\n\n  init(options) {\n    this.options = ObjectExt.merge(Halo.defaultOptions, this.cell.isNode() ? new NodePreset(this).getPresets() : this.cell.isEdge() ? new EdgePreset(this).getPresets() : null, options);\n    this.render();\n    this.initHandles();\n    this.update();\n    this.startListening();\n  }\n\n  startListening() {\n    const model = this.model;\n    const graph = this.graph;\n    const cell = this.view.cell;\n    cell.on('removed', this.remove, this);\n    model.on('reseted', this.remove, this);\n    graph.on('halo:destroy', this.remove, this);\n    model.on('*', this.update, this);\n    graph.on('scale', this.update, this);\n    graph.on('translate', this.update, this);\n    super.startListening();\n  }\n\n  stopListening() {\n    const model = this.model;\n    const graph = this.graph;\n    const cell = this.view.cell;\n    this.undelegateEvents();\n    cell.off('removed', this.remove, this);\n    model.off('reseted', this.remove, this);\n    graph.off('halo:destroy', this.remove, this);\n    model.off('*', this.update, this);\n    graph.off('scale', this.update, this);\n    graph.off('translate', this.update, this);\n    super.stopListening();\n  }\n\n  render() {\n    const options = this.options;\n    const cls = this.prefixClassName('widget-halo');\n    this.view.addClass(Private.NODE_CLS);\n    this.container = document.createElement('div');\n    this.$container = this.$(this.container).addClass(cls).attr('data-shape', this.view.cell.shape);\n\n    if (options.className) {\n      this.$container.addClass(options.className);\n    }\n\n    this.$handleContainer = this.$('<div/>').addClass(`${cls}-handles`).appendTo(this.container);\n    this.$content = this.$('<div/>').addClass(`${cls}-content`).appendTo(this.container);\n    this.$container.appendTo(this.graph.container);\n    return this;\n  }\n\n  remove() {\n    this.stopBatch();\n    this.view.removeClass(Private.NODE_CLS);\n    return super.remove();\n  }\n\n  update() {\n    if (this.isRendered()) {\n      this.updateContent();\n      const bbox = this.getBBox();\n      const tinyThreshold = this.options.tinyThreshold || 0;\n      const smallThreshold = this.options.smallThreshold || 0;\n      this.$handleContainer.toggleClass(`${this.handleClassName}-tiny`, bbox.width < tinyThreshold && bbox.height < tinyThreshold);\n      const className = `${this.handleClassName}-small`;\n      this.$handleContainer.toggleClass(className, !this.$handleContainer.hasClass(className) && bbox.width < smallThreshold && bbox.height < smallThreshold);\n      this.$container.css({\n        width: bbox.width,\n        height: bbox.height,\n        left: bbox.x,\n        top: bbox.y\n      });\n\n      if (this.hasHandle('unlink')) {\n        this.toggleUnlink();\n      }\n\n      if (this.type === 'surround' || this.type === 'toolbar') {\n        if (this.hasHandle('fork')) {\n          this.toggleFork();\n        }\n      }\n    }\n  }\n\n  updateContent() {\n    const content = this.options.content;\n\n    if (typeof content === 'function') {\n      const ret = FunctionExt.call(content, this, this.view, this.$content[0]);\n\n      if (ret) {\n        this.$content.html(ret);\n      }\n    } else if (content) {\n      this.$content.html(content);\n    } else {\n      this.$content.remove();\n    }\n  }\n\n  getBBox() {\n    const view = this.view;\n    const bbox = this.options.bbox;\n    const rect = typeof bbox === 'function' ? FunctionExt.call(bbox, this, view) : bbox;\n    return Rectangle.create(Object.assign({\n      x: 0,\n      y: 0,\n      width: 1,\n      height: 1\n    }, rect));\n  }\n\n  removeCell() {\n    this.cell.remove();\n  }\n\n  toggleFork() {\n    const cell = this.view.cell.clone();\n    const view = this.graph.hook.createCellView(cell);\n    const valid = this.graph.hook.validateConnection(this.view, null, view, null, 'target');\n    this.$handleContainer.children('.fork').toggleClass('hidden', !valid);\n    view.remove();\n  }\n\n  toggleUnlink() {\n    const hasEdges = this.model.getConnectedEdges(this.view.cell).length > 0;\n    this.$handleContainer.children('.unlink').toggleClass('hidden', !hasEdges);\n  } // #region batch\n\n\n  startBatch() {\n    this.model.startBatch('halo', {\n      halo: this.cid\n    });\n  }\n\n  stopBatch() {\n    if (this.model.hasActiveBatch('halo')) {\n      this.model.stopBatch('halo', {\n        halo: this.cid\n      });\n    }\n  }\n\n}\n\n(function (Halo) {\n  Halo.defaultOptions = {\n    type: 'surround',\n    clearAll: true,\n    clearOnBlankMouseDown: true,\n    useCellGeometry: false,\n    clone: cell => cell.clone().removeZIndex()\n  };\n})(Halo || (Halo = {}));\n\nObject.getOwnPropertyNames(Handle.prototype).forEach(name => {\n  if (name !== 'constructor') {\n    Object.defineProperty(Halo.prototype, name, Object.getOwnPropertyDescriptor(Handle.prototype, name));\n  }\n});\nvar Private;\n\n(function (Private) {\n  Private.NODE_CLS = 'has-widget-halo';\n})(Private || (Private = {}));","map":{"version":3,"mappings":"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","names":["ObjectExt","FunctionExt","Rectangle","Widget","Handle","NodePreset","EdgePreset","Halo","type","options","handleOptions","init","merge","defaultOptions","cell","isNode","getPresets","isEdge","render","initHandles","update","startListening","model","graph","view","on","remove","stopListening","undelegateEvents","off","cls","prefixClassName","addClass","Private","NODE_CLS","container","document","createElement","$container","$","attr","shape","className","$handleContainer","appendTo","$content","stopBatch","removeClass","isRendered","updateContent","bbox","getBBox","tinyThreshold","smallThreshold","toggleClass","handleClassName","width","height","hasClass","css","left","x","top","y","hasHandle","toggleUnlink","toggleFork","content","ret","call","html","rect","create","Object","removeCell","clone","hook","createCellView","valid","validateConnection","children","hasEdges","getConnectedEdges","length","startBatch","halo","cid","hasActiveBatch","clearAll","clearOnBlankMouseDown","useCellGeometry","removeZIndex","getOwnPropertyNames","prototype","forEach","name","defineProperty","getOwnPropertyDescriptor"],"sourceRoot":"","sources":["../../../src/addon/halo/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}