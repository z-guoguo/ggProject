{"ast":null,"code":"import \"core-js/modules/es.typed-array.at.js\";\nimport \"core-js/modules/es.typed-array.set.js\";\nimport \"core-js/modules/esnext.typed-array.find-last.js\";\nimport \"core-js/modules/esnext.typed-array.find-last-index.js\";\nimport \"core-js/modules/es.error.cause.js\";\nimport Matrix from '../matrix';\nimport WrapperMatrix2D from '../wrap/WrapperMatrix2D';\nimport { hypotenuse } from './util';\nexport default class QrDecomposition {\n  constructor(value) {\n    value = WrapperMatrix2D.checkMatrix(value);\n    let qr = value.clone();\n    let m = value.rows;\n    let n = value.columns;\n    let rdiag = new Float64Array(n);\n    let i, j, k, s;\n\n    for (k = 0; k < n; k++) {\n      let nrm = 0;\n\n      for (i = k; i < m; i++) {\n        nrm = hypotenuse(nrm, qr.get(i, k));\n      }\n\n      if (nrm !== 0) {\n        if (qr.get(k, k) < 0) {\n          nrm = -nrm;\n        }\n\n        for (i = k; i < m; i++) {\n          qr.set(i, k, qr.get(i, k) / nrm);\n        }\n\n        qr.set(k, k, qr.get(k, k) + 1);\n\n        for (j = k + 1; j < n; j++) {\n          s = 0;\n\n          for (i = k; i < m; i++) {\n            s += qr.get(i, k) * qr.get(i, j);\n          }\n\n          s = -s / qr.get(k, k);\n\n          for (i = k; i < m; i++) {\n            qr.set(i, j, qr.get(i, j) + s * qr.get(i, k));\n          }\n        }\n      }\n\n      rdiag[k] = -nrm;\n    }\n\n    this.QR = qr;\n    this.Rdiag = rdiag;\n  }\n\n  solve(value) {\n    value = Matrix.checkMatrix(value);\n    let qr = this.QR;\n    let m = qr.rows;\n\n    if (value.rows !== m) {\n      throw new Error('Matrix row dimensions must agree');\n    }\n\n    if (!this.isFullRank()) {\n      throw new Error('Matrix is rank deficient');\n    }\n\n    let count = value.columns;\n    let X = value.clone();\n    let n = qr.columns;\n    let i, j, k, s;\n\n    for (k = 0; k < n; k++) {\n      for (j = 0; j < count; j++) {\n        s = 0;\n\n        for (i = k; i < m; i++) {\n          s += qr.get(i, k) * X.get(i, j);\n        }\n\n        s = -s / qr.get(k, k);\n\n        for (i = k; i < m; i++) {\n          X.set(i, j, X.get(i, j) + s * qr.get(i, k));\n        }\n      }\n    }\n\n    for (k = n - 1; k >= 0; k--) {\n      for (j = 0; j < count; j++) {\n        X.set(k, j, X.get(k, j) / this.Rdiag[k]);\n      }\n\n      for (i = 0; i < k; i++) {\n        for (j = 0; j < count; j++) {\n          X.set(i, j, X.get(i, j) - X.get(k, j) * qr.get(i, k));\n        }\n      }\n    }\n\n    return X.subMatrix(0, n - 1, 0, count - 1);\n  }\n\n  isFullRank() {\n    let columns = this.QR.columns;\n\n    for (let i = 0; i < columns; i++) {\n      if (this.Rdiag[i] === 0) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  get upperTriangularMatrix() {\n    let qr = this.QR;\n    let n = qr.columns;\n    let X = new Matrix(n, n);\n    let i, j;\n\n    for (i = 0; i < n; i++) {\n      for (j = 0; j < n; j++) {\n        if (i < j) {\n          X.set(i, j, qr.get(i, j));\n        } else if (i === j) {\n          X.set(i, j, this.Rdiag[i]);\n        } else {\n          X.set(i, j, 0);\n        }\n      }\n    }\n\n    return X;\n  }\n\n  get orthogonalMatrix() {\n    let qr = this.QR;\n    let rows = qr.rows;\n    let columns = qr.columns;\n    let X = new Matrix(rows, columns);\n    let i, j, k, s;\n\n    for (k = columns - 1; k >= 0; k--) {\n      for (i = 0; i < rows; i++) {\n        X.set(i, k, 0);\n      }\n\n      X.set(k, k, 1);\n\n      for (j = k; j < columns; j++) {\n        if (qr.get(k, k) !== 0) {\n          s = 0;\n\n          for (i = k; i < rows; i++) {\n            s += qr.get(i, k) * X.get(i, j);\n          }\n\n          s = -s / qr.get(k, k);\n\n          for (i = k; i < rows; i++) {\n            X.set(i, j, X.get(i, j) + s * qr.get(i, k));\n          }\n        }\n      }\n    }\n\n    return X;\n  }\n\n}","map":{"version":3,"names":["Matrix","WrapperMatrix2D","hypotenuse","QrDecomposition","constructor","value","checkMatrix","qr","clone","m","rows","n","columns","rdiag","Float64Array","i","j","k","s","nrm","get","set","QR","Rdiag","solve","Error","isFullRank","count","X","subMatrix","upperTriangularMatrix","orthogonalMatrix"],"sources":["/Users/wawalike/Desktop/ggProject/node_modules/ml-matrix/src/dc/qr.js"],"sourcesContent":["import Matrix from '../matrix';\nimport WrapperMatrix2D from '../wrap/WrapperMatrix2D';\n\nimport { hypotenuse } from './util';\n\nexport default class QrDecomposition {\n  constructor(value) {\n    value = WrapperMatrix2D.checkMatrix(value);\n\n    let qr = value.clone();\n    let m = value.rows;\n    let n = value.columns;\n    let rdiag = new Float64Array(n);\n    let i, j, k, s;\n\n    for (k = 0; k < n; k++) {\n      let nrm = 0;\n      for (i = k; i < m; i++) {\n        nrm = hypotenuse(nrm, qr.get(i, k));\n      }\n      if (nrm !== 0) {\n        if (qr.get(k, k) < 0) {\n          nrm = -nrm;\n        }\n        for (i = k; i < m; i++) {\n          qr.set(i, k, qr.get(i, k) / nrm);\n        }\n        qr.set(k, k, qr.get(k, k) + 1);\n        for (j = k + 1; j < n; j++) {\n          s = 0;\n          for (i = k; i < m; i++) {\n            s += qr.get(i, k) * qr.get(i, j);\n          }\n          s = -s / qr.get(k, k);\n          for (i = k; i < m; i++) {\n            qr.set(i, j, qr.get(i, j) + s * qr.get(i, k));\n          }\n        }\n      }\n      rdiag[k] = -nrm;\n    }\n\n    this.QR = qr;\n    this.Rdiag = rdiag;\n  }\n\n  solve(value) {\n    value = Matrix.checkMatrix(value);\n\n    let qr = this.QR;\n    let m = qr.rows;\n\n    if (value.rows !== m) {\n      throw new Error('Matrix row dimensions must agree');\n    }\n    if (!this.isFullRank()) {\n      throw new Error('Matrix is rank deficient');\n    }\n\n    let count = value.columns;\n    let X = value.clone();\n    let n = qr.columns;\n    let i, j, k, s;\n\n    for (k = 0; k < n; k++) {\n      for (j = 0; j < count; j++) {\n        s = 0;\n        for (i = k; i < m; i++) {\n          s += qr.get(i, k) * X.get(i, j);\n        }\n        s = -s / qr.get(k, k);\n        for (i = k; i < m; i++) {\n          X.set(i, j, X.get(i, j) + s * qr.get(i, k));\n        }\n      }\n    }\n    for (k = n - 1; k >= 0; k--) {\n      for (j = 0; j < count; j++) {\n        X.set(k, j, X.get(k, j) / this.Rdiag[k]);\n      }\n      for (i = 0; i < k; i++) {\n        for (j = 0; j < count; j++) {\n          X.set(i, j, X.get(i, j) - X.get(k, j) * qr.get(i, k));\n        }\n      }\n    }\n\n    return X.subMatrix(0, n - 1, 0, count - 1);\n  }\n\n  isFullRank() {\n    let columns = this.QR.columns;\n    for (let i = 0; i < columns; i++) {\n      if (this.Rdiag[i] === 0) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  get upperTriangularMatrix() {\n    let qr = this.QR;\n    let n = qr.columns;\n    let X = new Matrix(n, n);\n    let i, j;\n    for (i = 0; i < n; i++) {\n      for (j = 0; j < n; j++) {\n        if (i < j) {\n          X.set(i, j, qr.get(i, j));\n        } else if (i === j) {\n          X.set(i, j, this.Rdiag[i]);\n        } else {\n          X.set(i, j, 0);\n        }\n      }\n    }\n    return X;\n  }\n\n  get orthogonalMatrix() {\n    let qr = this.QR;\n    let rows = qr.rows;\n    let columns = qr.columns;\n    let X = new Matrix(rows, columns);\n    let i, j, k, s;\n\n    for (k = columns - 1; k >= 0; k--) {\n      for (i = 0; i < rows; i++) {\n        X.set(i, k, 0);\n      }\n      X.set(k, k, 1);\n      for (j = k; j < columns; j++) {\n        if (qr.get(k, k) !== 0) {\n          s = 0;\n          for (i = k; i < rows; i++) {\n            s += qr.get(i, k) * X.get(i, j);\n          }\n\n          s = -s / qr.get(k, k);\n\n          for (i = k; i < rows; i++) {\n            X.set(i, j, X.get(i, j) + s * qr.get(i, k));\n          }\n        }\n      }\n    }\n    return X;\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}