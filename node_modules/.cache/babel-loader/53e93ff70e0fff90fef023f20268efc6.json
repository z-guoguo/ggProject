{"ast":null,"code":"\"use strict\";\n\nrequire(\"core-js/modules/es.error.cause.js\");\n\nvar __spreadArray = this && this.__spreadArray || function (to, from) {\n  for (var i = 0, il = from.length, j = to.length; i < il; i++, j++) to[j] = from[i];\n\n  return to;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getFunctionName = exports.getBaseClassDependencyCount = exports.getDependencies = void 0;\n\nvar inject_1 = require(\"../annotation/inject\");\n\nvar ERROR_MSGS = require(\"../constants/error_msgs\");\n\nvar literal_types_1 = require(\"../constants/literal_types\");\n\nvar METADATA_KEY = require(\"../constants/metadata_keys\");\n\nvar serialization_1 = require(\"../utils/serialization\");\n\nObject.defineProperty(exports, \"getFunctionName\", {\n  enumerable: true,\n  get: function () {\n    return serialization_1.getFunctionName;\n  }\n});\n\nvar target_1 = require(\"./target\");\n\nfunction getDependencies(metadataReader, func) {\n  var constructorName = serialization_1.getFunctionName(func);\n  var targets = getTargets(metadataReader, constructorName, func, false);\n  return targets;\n}\n\nexports.getDependencies = getDependencies;\n\nfunction getTargets(metadataReader, constructorName, func, isBaseClass) {\n  var metadata = metadataReader.getConstructorMetadata(func);\n  var serviceIdentifiers = metadata.compilerGeneratedMetadata;\n\n  if (serviceIdentifiers === undefined) {\n    var msg = ERROR_MSGS.MISSING_INJECTABLE_ANNOTATION + \" \" + constructorName + \".\";\n    throw new Error(msg);\n  }\n\n  var constructorArgsMetadata = metadata.userGeneratedMetadata;\n  var keys = Object.keys(constructorArgsMetadata);\n  var hasUserDeclaredUnknownInjections = func.length === 0 && keys.length > 0;\n  var hasOptionalParameters = keys.length > func.length;\n  var iterations = hasUserDeclaredUnknownInjections || hasOptionalParameters ? keys.length : func.length;\n  var constructorTargets = getConstructorArgsAsTargets(isBaseClass, constructorName, serviceIdentifiers, constructorArgsMetadata, iterations);\n  var propertyTargets = getClassPropsAsTargets(metadataReader, func);\n\n  var targets = __spreadArray(__spreadArray([], constructorTargets), propertyTargets);\n\n  return targets;\n}\n\nfunction getConstructorArgsAsTarget(index, isBaseClass, constructorName, serviceIdentifiers, constructorArgsMetadata) {\n  var targetMetadata = constructorArgsMetadata[index.toString()] || [];\n  var metadata = formatTargetMetadata(targetMetadata);\n  var isManaged = metadata.unmanaged !== true;\n  var serviceIdentifier = serviceIdentifiers[index];\n  var injectIdentifier = metadata.inject || metadata.multiInject;\n  serviceIdentifier = injectIdentifier ? injectIdentifier : serviceIdentifier;\n\n  if (serviceIdentifier instanceof inject_1.LazyServiceIdentifer) {\n    serviceIdentifier = serviceIdentifier.unwrap();\n  }\n\n  if (isManaged) {\n    var isObject = serviceIdentifier === Object;\n    var isFunction = serviceIdentifier === Function;\n    var isUndefined = serviceIdentifier === undefined;\n    var isUnknownType = isObject || isFunction || isUndefined;\n\n    if (!isBaseClass && isUnknownType) {\n      var msg = ERROR_MSGS.MISSING_INJECT_ANNOTATION + \" argument \" + index + \" in class \" + constructorName + \".\";\n      throw new Error(msg);\n    }\n\n    var target = new target_1.Target(literal_types_1.TargetTypeEnum.ConstructorArgument, metadata.targetName, serviceIdentifier);\n    target.metadata = targetMetadata;\n    return target;\n  }\n\n  return null;\n}\n\nfunction getConstructorArgsAsTargets(isBaseClass, constructorName, serviceIdentifiers, constructorArgsMetadata, iterations) {\n  var targets = [];\n\n  for (var i = 0; i < iterations; i++) {\n    var index = i;\n    var target = getConstructorArgsAsTarget(index, isBaseClass, constructorName, serviceIdentifiers, constructorArgsMetadata);\n\n    if (target !== null) {\n      targets.push(target);\n    }\n  }\n\n  return targets;\n}\n\nfunction getClassPropsAsTargets(metadataReader, constructorFunc) {\n  var classPropsMetadata = metadataReader.getPropertiesMetadata(constructorFunc);\n  var targets = [];\n  var keys = Object.keys(classPropsMetadata);\n\n  for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {\n    var key = keys_1[_i];\n    var targetMetadata = classPropsMetadata[key];\n    var metadata = formatTargetMetadata(classPropsMetadata[key]);\n    var targetName = metadata.targetName || key;\n    var serviceIdentifier = metadata.inject || metadata.multiInject;\n    var target = new target_1.Target(literal_types_1.TargetTypeEnum.ClassProperty, targetName, serviceIdentifier);\n    target.metadata = targetMetadata;\n    targets.push(target);\n  }\n\n  var baseConstructor = Object.getPrototypeOf(constructorFunc.prototype).constructor;\n\n  if (baseConstructor !== Object) {\n    var baseTargets = getClassPropsAsTargets(metadataReader, baseConstructor);\n    targets = __spreadArray(__spreadArray([], targets), baseTargets);\n  }\n\n  return targets;\n}\n\nfunction getBaseClassDependencyCount(metadataReader, func) {\n  var baseConstructor = Object.getPrototypeOf(func.prototype).constructor;\n\n  if (baseConstructor !== Object) {\n    var baseConstructorName = serialization_1.getFunctionName(baseConstructor);\n    var targets = getTargets(metadataReader, baseConstructorName, baseConstructor, true);\n    var metadata = targets.map(function (t) {\n      return t.metadata.filter(function (m) {\n        return m.key === METADATA_KEY.UNMANAGED_TAG;\n      });\n    });\n    var unmanagedCount = [].concat.apply([], metadata).length;\n    var dependencyCount = targets.length - unmanagedCount;\n\n    if (dependencyCount > 0) {\n      return dependencyCount;\n    } else {\n      return getBaseClassDependencyCount(metadataReader, baseConstructor);\n    }\n  } else {\n    return 0;\n  }\n}\n\nexports.getBaseClassDependencyCount = getBaseClassDependencyCount;\n\nfunction formatTargetMetadata(targetMetadata) {\n  var targetMetadataMap = {};\n  targetMetadata.forEach(function (m) {\n    targetMetadataMap[m.key.toString()] = m.value;\n  });\n  return {\n    inject: targetMetadataMap[METADATA_KEY.INJECT_TAG],\n    multiInject: targetMetadataMap[METADATA_KEY.MULTI_INJECT_TAG],\n    targetName: targetMetadataMap[METADATA_KEY.NAME_TAG],\n    unmanaged: targetMetadataMap[METADATA_KEY.UNMANAGED_TAG]\n  };\n}","map":{"version":3,"mappings":"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","names":["Object","enumerable","get","serialization_1","getDependencies","metadataReader","func","constructorName","targets","getTargets","exports","isBaseClass","metadata","getConstructorMetadata","serviceIdentifiers","compilerGeneratedMetadata","undefined","msg","ERROR_MSGS","MISSING_INJECTABLE_ANNOTATION","Error","constructorArgsMetadata","userGeneratedMetadata","keys","hasUserDeclaredUnknownInjections","length","hasOptionalParameters","iterations","constructorTargets","getConstructorArgsAsTargets","propertyTargets","getClassPropsAsTargets","getConstructorArgsAsTarget","index","targetMetadata","toString","formatTargetMetadata","isManaged","unmanaged","serviceIdentifier","injectIdentifier","inject","multiInject","inject_1","unwrap","isObject","isFunction","Function","isUndefined","isUnknownType","MISSING_INJECT_ANNOTATION","target","target_1","literal_types_1","ConstructorArgument","targetName","i","push","constructorFunc","classPropsMetadata","getPropertiesMetadata","_i","key","ClassProperty","baseConstructor","getPrototypeOf","prototype","constructor","baseTargets","getBaseClassDependencyCount","baseConstructorName","map","t","filter","m","METADATA_KEY","UNMANAGED_TAG","unmanagedCount","concat","apply","dependencyCount","targetMetadataMap","forEach","value","INJECT_TAG","MULTI_INJECT_TAG","NAME_TAG"],"sourceRoot":"","sources":["../../src/planning/reflection_utils.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}