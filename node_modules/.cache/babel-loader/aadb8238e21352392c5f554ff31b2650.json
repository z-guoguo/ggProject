{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar barycenter_1 = __importDefault(require(\"./barycenter\"));\n\nvar resolve_conflicts_1 = __importDefault(require(\"./resolve-conflicts\"));\n\nvar sort_1 = __importDefault(require(\"./sort\"));\n\nvar sortSubgraph = function (g, v, cg, biasRight, usePrev) {\n  var _a, _b, _c, _d;\n\n  var movable = g.children(v); // fixorder的点不参与排序（这个方案不合适，只排了新增节点，和原来的分离）\n\n  var node = g.node(v);\n  var bl = node ? node.borderLeft : undefined;\n  var br = node ? node.borderRight : undefined;\n  var subgraphs = {};\n\n  if (bl) {\n    movable = movable === null || movable === void 0 ? void 0 : movable.filter(function (w) {\n      return w !== bl && w !== br;\n    });\n  }\n\n  var barycenters = (0, barycenter_1.default)(g, movable || []);\n  barycenters === null || barycenters === void 0 ? void 0 : barycenters.forEach(function (entry) {\n    var _a;\n\n    if ((_a = g.children(entry.v)) === null || _a === void 0 ? void 0 : _a.length) {\n      var subgraphResult = sortSubgraph(g, entry.v, cg, biasRight);\n      subgraphs[entry.v] = subgraphResult;\n\n      if (subgraphResult.hasOwnProperty(\"barycenter\")) {\n        mergeBarycenters(entry, subgraphResult);\n      }\n    }\n  });\n  var entries = (0, resolve_conflicts_1.default)(barycenters, cg);\n  expandSubgraphs(entries, subgraphs); // 添加fixorder信息到entries里边\n  // TODO: 不考虑复合情况，只用第一个点的fixorder信息，后续考虑更完备的实现\n\n  (_a = entries.filter(function (e) {\n    return e.vs.length > 0;\n  })) === null || _a === void 0 ? void 0 : _a.forEach(function (e) {\n    var node = g.node(e.vs[0]);\n\n    if (node) {\n      e.fixorder = node.fixorder;\n      e.order = node.order;\n    }\n  });\n  var result = (0, sort_1.default)(entries, biasRight, usePrev);\n\n  if (bl) {\n    result.vs = [bl, result.vs, br].flat();\n\n    if ((_b = g.predecessors(bl)) === null || _b === void 0 ? void 0 : _b.length) {\n      var blPred = g.node(((_c = g.predecessors(bl)) === null || _c === void 0 ? void 0 : _c[0]) || \"\");\n      var brPred = g.node(((_d = g.predecessors(br)) === null || _d === void 0 ? void 0 : _d[0]) || \"\");\n\n      if (!result.hasOwnProperty(\"barycenter\")) {\n        result.barycenter = 0;\n        result.weight = 0;\n      }\n\n      result.barycenter = (result.barycenter * result.weight + blPred.order + brPred.order) / (result.weight + 2);\n      result.weight += 2;\n    }\n  }\n\n  return result;\n};\n\nvar expandSubgraphs = function (entries, subgraphs) {\n  entries === null || entries === void 0 ? void 0 : entries.forEach(function (entry) {\n    var _a;\n\n    var vss = (_a = entry.vs) === null || _a === void 0 ? void 0 : _a.map(function (v) {\n      if (subgraphs[v]) {\n        return subgraphs[v].vs;\n      }\n\n      return v;\n    });\n    entry.vs = vss.flat();\n  });\n};\n\nvar mergeBarycenters = function (target, other) {\n  if (target.barycenter !== undefined) {\n    target.barycenter = (target.barycenter * target.weight + other.barycenter * other.weight) / (target.weight + other.weight);\n    target.weight += other.weight;\n  } else {\n    target.barycenter = other.barycenter;\n    target.weight = other.weight;\n  }\n};\n\nexports.default = sortSubgraph;","map":{"version":3,"mappings":"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","names":["sortSubgraph","g","v","cg","biasRight","usePrev","movable","children","node","bl","borderLeft","undefined","br","borderRight","subgraphs","filter","w","barycenters","forEach","entry","_a","length","subgraphResult","hasOwnProperty","mergeBarycenters","entries","expandSubgraphs","e","vs","fixorder","order","result","flat","predecessors","_b","blPred","_c","brPred","_d","barycenter","weight","vss","map","target","other","exports"],"sourceRoot":"","sources":["../../../../../src/layout/dagre/src/order/sort-subgraph.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}