{"ast":null,"code":"import { Dom, ObjectExt, FunctionExt } from '../../util';\nimport { Point, Line } from '../../geometry';\nimport { View } from '../../view/view';\nimport { ToolsView } from '../../view/tool';\nimport * as Util from './util';\nexport class Segments extends ToolsView.ToolItem {\n  constructor() {\n    super(...arguments);\n    this.handles = [];\n  }\n\n  get vertices() {\n    return this.cellView.cell.getVertices();\n  }\n\n  update() {\n    this.render();\n    return this;\n  }\n\n  onRender() {\n    Dom.addClass(this.container, this.prefixClassName('edge-tool-segments'));\n    this.resetHandles();\n    const edgeView = this.cellView;\n    const vertices = [...this.vertices];\n    vertices.unshift(edgeView.sourcePoint);\n    vertices.push(edgeView.targetPoint);\n\n    for (let i = 0, l = vertices.length; i < l - 1; i += 1) {\n      const vertex = vertices[i];\n      const nextVertex = vertices[i + 1];\n      const handle = this.renderHandle(vertex, nextVertex, i);\n      this.stamp(handle.container);\n      this.handles.push(handle);\n    }\n\n    return this;\n  }\n\n  renderHandle(vertex, nextVertex, index) {\n    const handle = this.options.createHandle({\n      index,\n      graph: this.graph,\n      guard: evt => this.guard(evt),\n      attrs: this.options.attrs || {}\n    });\n\n    if (this.options.processHandle) {\n      this.options.processHandle(handle);\n    }\n\n    this.graph.hook.onToolItemCreated({\n      name: 'segments',\n      cell: this.cell,\n      view: this.cellView,\n      tool: handle\n    });\n    this.updateHandle(handle, vertex, nextVertex);\n    this.container.appendChild(handle.container);\n    this.startHandleListening(handle);\n    return handle;\n  }\n\n  startHandleListening(handle) {\n    handle.on('change', this.onHandleChange, this);\n    handle.on('changing', this.onHandleChanging, this);\n    handle.on('changed', this.onHandleChanged, this);\n  }\n\n  stopHandleListening(handle) {\n    handle.off('change', this.onHandleChange, this);\n    handle.off('changing', this.onHandleChanging, this);\n    handle.off('changed', this.onHandleChanged, this);\n  }\n\n  resetHandles() {\n    const handles = this.handles;\n    this.handles = [];\n\n    if (handles) {\n      handles.forEach(handle => {\n        this.stopHandleListening(handle);\n        handle.remove();\n      });\n    }\n  }\n\n  shiftHandleIndexes(delta) {\n    const handles = this.handles;\n\n    for (let i = 0, n = handles.length; i < n; i += 1) {\n      handles[i].options.index += delta;\n    }\n  }\n\n  resetAnchor(type, anchor) {\n    const edge = this.cellView.cell;\n    const options = {\n      ui: true,\n      toolId: this.cid\n    };\n\n    if (anchor) {\n      edge.prop([type, 'anchor'], anchor, options);\n    } else {\n      edge.removeProp([type, 'anchor'], options);\n    }\n  }\n\n  snapHandle(handle, position, data) {\n    const axis = handle.options.axis;\n    const index = handle.options.index;\n    const edgeView = this.cellView;\n    const edge = edgeView.cell;\n    const vertices = edge.getVertices();\n    const prev = vertices[index - 2] || data.sourceAnchor;\n    const next = vertices[index + 1] || data.targetAnchor;\n    const snapRadius = this.options.snapRadius;\n\n    if (Math.abs(position[axis] - prev[axis]) < snapRadius) {\n      position[axis] = prev[axis];\n    } else if (Math.abs(position[axis] - next[axis]) < snapRadius) {\n      position[axis] = next[axis];\n    }\n\n    return position;\n  }\n\n  onHandleChanging({\n    handle,\n    e\n  }) {\n    const graph = this.graph;\n    const options = this.options;\n    const edgeView = this.cellView;\n    const anchorFn = options.anchor;\n    const axis = handle.options.axis;\n    const index = handle.options.index - 1;\n    const data = this.getEventData(e);\n    const evt = this.normalizeEvent(e);\n    const coords = graph.snapToGrid(evt.clientX, evt.clientY);\n    const position = this.snapHandle(handle, coords.clone(), data);\n    const vertices = ObjectExt.cloneDeep(this.vertices);\n    let vertex = vertices[index];\n    let nextVertex = vertices[index + 1]; // First Segment\n\n    const sourceView = edgeView.sourceView;\n    const sourceBBox = edgeView.sourceBBox;\n    let changeSourceAnchor = false;\n    let deleteSourceAnchor = false;\n\n    if (!vertex) {\n      vertex = edgeView.sourceAnchor.toJSON();\n      vertex[axis] = position[axis];\n\n      if (sourceBBox.containsPoint(vertex)) {\n        changeSourceAnchor = true;\n      } else {\n        vertices.unshift(vertex);\n        this.shiftHandleIndexes(1);\n        deleteSourceAnchor = true;\n      }\n    } else if (index === 0) {\n      if (sourceBBox.containsPoint(vertex)) {\n        vertices.shift();\n        this.shiftHandleIndexes(-1);\n        changeSourceAnchor = true;\n      } else {\n        vertex[axis] = position[axis];\n        deleteSourceAnchor = true;\n      }\n    } else {\n      vertex[axis] = position[axis];\n    }\n\n    if (typeof anchorFn === 'function' && sourceView) {\n      if (changeSourceAnchor) {\n        const sourceAnchorPosition = data.sourceAnchor.clone();\n        sourceAnchorPosition[axis] = position[axis];\n        const sourceAnchor = FunctionExt.call(anchorFn, edgeView, sourceAnchorPosition, sourceView, edgeView.sourceMagnet || sourceView.container, 'source', edgeView, this);\n        this.resetAnchor('source', sourceAnchor);\n      }\n\n      if (deleteSourceAnchor) {\n        this.resetAnchor('source', data.sourceAnchorDef);\n      }\n    } // Last segment\n\n\n    const targetView = edgeView.targetView;\n    const targetBBox = edgeView.targetBBox;\n    let changeTargetAnchor = false;\n    let deleteTargetAnchor = false;\n\n    if (!nextVertex) {\n      nextVertex = edgeView.targetAnchor.toJSON();\n      nextVertex[axis] = position[axis];\n\n      if (targetBBox.containsPoint(nextVertex)) {\n        changeTargetAnchor = true;\n      } else {\n        vertices.push(nextVertex);\n        deleteTargetAnchor = true;\n      }\n    } else if (index === vertices.length - 2) {\n      if (targetBBox.containsPoint(nextVertex)) {\n        vertices.pop();\n        changeTargetAnchor = true;\n      } else {\n        nextVertex[axis] = position[axis];\n        deleteTargetAnchor = true;\n      }\n    } else {\n      nextVertex[axis] = position[axis];\n    }\n\n    if (typeof anchorFn === 'function' && targetView) {\n      if (changeTargetAnchor) {\n        const targetAnchorPosition = data.targetAnchor.clone();\n        targetAnchorPosition[axis] = position[axis];\n        const targetAnchor = FunctionExt.call(anchorFn, edgeView, targetAnchorPosition, targetView, edgeView.targetMagnet || targetView.container, 'target', edgeView, this);\n        this.resetAnchor('target', targetAnchor);\n      }\n\n      if (deleteTargetAnchor) {\n        this.resetAnchor('target', data.targetAnchorDef);\n      }\n    }\n\n    if (!Point.equalPoints(vertices, this.vertices)) {\n      this.cellView.cell.setVertices(vertices, {\n        ui: true,\n        toolId: this.cid\n      });\n    }\n\n    this.updateHandle(handle, vertex, nextVertex, 0);\n\n    if (!options.stopPropagation) {\n      edgeView.notifyMouseMove(evt, coords.x, coords.y);\n    }\n  }\n\n  onHandleChange({\n    handle,\n    e\n  }) {\n    const options = this.options;\n    const handles = this.handles;\n    const edgeView = this.cellView;\n    const index = handle.options.index;\n\n    if (!Array.isArray(handles)) {\n      return;\n    }\n\n    for (let i = 0, n = handles.length; i < n; i += 1) {\n      if (i !== index) {\n        handles[i].hide();\n      }\n    }\n\n    this.focus();\n    this.setEventData(e, {\n      sourceAnchor: edgeView.sourceAnchor.clone(),\n      targetAnchor: edgeView.targetAnchor.clone(),\n      sourceAnchorDef: ObjectExt.cloneDeep(this.cell.prop(['source', 'anchor'])),\n      targetAnchorDef: ObjectExt.cloneDeep(this.cell.prop(['target', 'anchor']))\n    });\n    this.cell.startBatch('move-segment', {\n      ui: true,\n      toolId: this.cid\n    });\n\n    if (!options.stopPropagation) {\n      const normalizedEvent = this.normalizeEvent(e);\n      const coords = this.graph.snapToGrid(normalizedEvent.clientX, normalizedEvent.clientY);\n      edgeView.notifyMouseDown(normalizedEvent, coords.x, coords.y);\n    }\n  }\n\n  onHandleChanged({\n    e\n  }) {\n    const options = this.options;\n    const edgeView = this.cellView;\n\n    if (options.removeRedundancies) {\n      edgeView.removeRedundantLinearVertices({\n        ui: true,\n        toolId: this.cid\n      });\n    }\n\n    const normalizedEvent = this.normalizeEvent(e);\n    const coords = this.graph.snapToGrid(normalizedEvent.clientX, normalizedEvent.clientY);\n    this.render();\n    this.blur();\n    this.cell.stopBatch('move-segment', {\n      ui: true,\n      toolId: this.cid\n    });\n\n    if (!options.stopPropagation) {\n      edgeView.notifyMouseUp(normalizedEvent, coords.x, coords.y);\n    }\n\n    edgeView.checkMouseleave(normalizedEvent);\n    options.onChanged && options.onChanged({\n      edge: edgeView.cell,\n      edgeView\n    });\n  }\n\n  updateHandle(handle, vertex, nextVertex, offset = 0) {\n    const precision = this.options.precision || 0;\n    const vertical = Math.abs(vertex.x - nextVertex.x) < precision;\n    const horizontal = Math.abs(vertex.y - nextVertex.y) < precision;\n\n    if (vertical || horizontal) {\n      const segmentLine = new Line(vertex, nextVertex);\n      const length = segmentLine.length();\n\n      if (length < this.options.threshold) {\n        handle.hide();\n      } else {\n        const position = segmentLine.getCenter();\n        const axis = vertical ? 'x' : 'y';\n        position[axis] += offset || 0;\n        const angle = segmentLine.vector().vectorAngle(new Point(1, 0));\n        handle.updatePosition(position.x, position.y, angle, this.cellView);\n        handle.show();\n        handle.options.axis = axis;\n      }\n    } else {\n      handle.hide();\n    }\n  }\n\n  onRemove() {\n    this.resetHandles();\n  }\n\n}\n\n(function (Segments) {\n  class Handle extends View {\n    constructor(options) {\n      super();\n      this.options = options;\n      this.render();\n      this.delegateEvents({\n        mousedown: 'onMouseDown',\n        touchstart: 'onMouseDown'\n      });\n    }\n\n    render() {\n      this.container = View.createElement('rect', true);\n      const attrs = this.options.attrs;\n\n      if (typeof attrs === 'function') {\n        const defaults = Segments.getDefaults();\n        this.setAttrs(Object.assign(Object.assign({}, defaults.attrs), attrs(this)));\n      } else {\n        this.setAttrs(attrs);\n      }\n\n      this.addClass(this.prefixClassName('edge-tool-segment'));\n    }\n\n    updatePosition(x, y, angle, view) {\n      const p = view.getClosestPoint(new Point(x, y)) || new Point(x, y);\n      let matrix = Dom.createSVGMatrix().translate(p.x, p.y);\n\n      if (!p.equals({\n        x,\n        y\n      })) {\n        const line = new Line(x, y, p.x, p.y);\n        let deg = line.vector().vectorAngle(new Point(1, 0));\n\n        if (deg !== 0) {\n          deg += 90;\n        }\n\n        matrix = matrix.rotate(deg);\n      } else {\n        matrix = matrix.rotate(angle);\n      }\n\n      this.setAttrs({\n        transform: Dom.matrixToTransformString(matrix),\n        cursor: angle % 180 === 0 ? 'row-resize' : 'col-resize'\n      });\n    }\n\n    onMouseDown(evt) {\n      if (this.options.guard(evt)) {\n        return;\n      }\n\n      this.trigger('change', {\n        e: evt,\n        handle: this\n      });\n      evt.stopPropagation();\n      evt.preventDefault();\n      this.options.graph.view.undelegateEvents();\n      this.delegateDocumentEvents({\n        mousemove: 'onMouseMove',\n        touchmove: 'onMouseMove',\n        mouseup: 'onMouseUp',\n        touchend: 'onMouseUp',\n        touchcancel: 'onMouseUp'\n      }, evt.data);\n    }\n\n    onMouseMove(evt) {\n      this.emit('changing', {\n        e: evt,\n        handle: this\n      });\n    }\n\n    onMouseUp(evt) {\n      this.emit('changed', {\n        e: evt,\n        handle: this\n      });\n      this.undelegateDocumentEvents();\n      this.options.graph.view.delegateEvents();\n    }\n\n    show() {\n      this.container.style.display = '';\n    }\n\n    hide() {\n      this.container.style.display = 'none';\n    }\n\n  }\n\n  Segments.Handle = Handle;\n})(Segments || (Segments = {}));\n\n(function (Segments) {\n  Segments.config({\n    name: 'segments',\n    precision: 0.5,\n    threshold: 40,\n    snapRadius: 10,\n    stopPropagation: true,\n    removeRedundancies: true,\n    attrs: {\n      width: 20,\n      height: 8,\n      x: -10,\n      y: -4,\n      rx: 4,\n      ry: 4,\n      fill: '#333',\n      stroke: '#fff',\n      'stroke-width': 2\n    },\n    createHandle: options => new Segments.Handle(options),\n    anchor: Util.getAnchor\n  });\n})(Segments || (Segments = {}));","map":{"version":3,"mappings":"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","names":["Dom","ObjectExt","FunctionExt","Point","Line","View","ToolsView","Util","Segments","ToolItem","constructor","vertices","cellView","cell","getVertices","update","render","onRender","addClass","container","prefixClassName","resetHandles","edgeView","unshift","sourcePoint","push","targetPoint","i","l","length","vertex","nextVertex","handle","renderHandle","stamp","handles","index","options","createHandle","graph","guard","evt","attrs","processHandle","hook","onToolItemCreated","name","view","tool","updateHandle","appendChild","startHandleListening","on","onHandleChange","onHandleChanging","onHandleChanged","stopHandleListening","off","forEach","remove","shiftHandleIndexes","delta","n","resetAnchor","type","anchor","edge","ui","toolId","cid","prop","removeProp","snapHandle","position","data","axis","prev","sourceAnchor","next","targetAnchor","snapRadius","Math","abs","e","anchorFn","getEventData","normalizeEvent","coords","snapToGrid","clientX","clientY","clone","cloneDeep","sourceView","sourceBBox","changeSourceAnchor","deleteSourceAnchor","toJSON","containsPoint","shift","sourceAnchorPosition","call","sourceMagnet","sourceAnchorDef","targetView","targetBBox","changeTargetAnchor","deleteTargetAnchor","pop","targetAnchorPosition","targetMagnet","targetAnchorDef","equalPoints","setVertices","stopPropagation","notifyMouseMove","x","y","Array","isArray","hide","focus","setEventData","startBatch","normalizedEvent","notifyMouseDown","removeRedundancies","removeRedundantLinearVertices","blur","stopBatch","notifyMouseUp","checkMouseleave","onChanged","offset","precision","vertical","horizontal","segmentLine","threshold","getCenter","angle","vector","vectorAngle","updatePosition","show","onRemove","Handle","delegateEvents","mousedown","touchstart","createElement","defaults","getDefaults","setAttrs","Object","p","getClosestPoint","matrix","createSVGMatrix","translate","equals","line","deg","rotate","transform","matrixToTransformString","cursor","onMouseDown","trigger","preventDefault","undelegateEvents","delegateDocumentEvents","mousemove","touchmove","mouseup","touchend","touchcancel","onMouseMove","emit","onMouseUp","undelegateDocumentEvents","style","display","config","width","height","rx","ry","fill","stroke","getAnchor"],"sourceRoot":"","sources":["../../../src/registry/tool/segments.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}