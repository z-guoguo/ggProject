{"ast":null,"code":"import { ToolsView } from '../../view/tool';\nimport { Point } from '../../geometry';\nimport { Dom, FunctionExt } from '../../util';\nexport class CellEditor extends ToolsView.ToolItem {\n  constructor() {\n    super(...arguments);\n    this.labelIndex = -1;\n    this.distance = 0.5;\n  }\n\n  render() {\n    this.createElement();\n    this.update();\n    this.autoFocus();\n    this.delegateDocumentEvents(this.options.documentEvents);\n    return this;\n  }\n\n  createElement() {\n    const {\n      cell\n    } = this;\n    const classNames = [this.prefixClassName(`${cell.isEdge() ? 'edge' : 'node'}-tool-editor`), this.prefixClassName('cell-tool-editor')];\n    this.editor = ToolsView.createElement('div', false);\n    this.addClass(classNames, this.editor);\n    this.editor.contentEditable = 'true';\n    this.container.appendChild(this.editor);\n  }\n\n  update() {\n    const {\n      graph,\n      cell,\n      editor\n    } = this;\n    const style = editor.style; // set tool position\n\n    let pos = new Point();\n    let minWidth = 20;\n\n    if (cell.isNode()) {\n      pos = cell.getBBox().center;\n      minWidth = cell.size().width - 4;\n    } else if (cell.isEdge()) {\n      const e = this.options.event;\n      const target = e.target;\n      const parent = target.parentElement;\n      const isEdgeLabel = parent && Dom.hasClass(parent, this.prefixClassName('edge-label'));\n\n      if (isEdgeLabel) {\n        const index = parent.getAttribute('data-index') || '0';\n        this.labelIndex = parseInt(index, 10);\n        const matrix = parent.getAttribute('transform');\n        const {\n          translation\n        } = Dom.parseTransformString(matrix);\n        pos = new Point(translation.tx, translation.ty);\n        minWidth = Dom.getBBox(target).width;\n      } else {\n        if (!this.options.labelAddable) {\n          return this;\n        }\n\n        pos = graph.clientToLocal(Point.create(e.clientX, e.clientY));\n        const view = this.cellView;\n        const d = view.path.closestPointLength(pos);\n        this.distance = d;\n      }\n    }\n\n    pos = graph.localToGraph(pos);\n    style.left = `${pos.x}px`;\n    style.top = `${pos.y}px`;\n    style.minWidth = `${minWidth}px`; // set tool transform\n\n    const scale = graph.scale();\n    style.transform = `scale(${scale.sx}, ${scale.sy}) translate(-50%, -50%)`; // set font style\n\n    const attrs = this.options.attrs;\n    style.fontSize = `${attrs.fontSize}px`;\n    style.fontFamily = attrs.fontFamily;\n    style.color = attrs.color;\n    style.backgroundColor = attrs.backgroundColor; // set init value\n\n    const getText = this.options.getText;\n    let text;\n\n    if (typeof getText === 'function') {\n      text = FunctionExt.call(getText, this.cellView, {\n        cell: this.cell,\n        index: this.labelIndex\n      });\n    }\n\n    editor.innerText = text || '';\n    return this;\n  }\n\n  onDocumentMouseDown(e) {\n    if (e.target !== this.editor) {\n      const cell = this.cell;\n      const value = this.editor.innerText.replace(/\\n$/, '') || ''; // set value\n\n      const setText = this.options.setText;\n\n      if (typeof setText === 'function') {\n        FunctionExt.call(setText, this.cellView, {\n          cell: this.cell,\n          value,\n          index: this.labelIndex,\n          distance: this.distance\n        });\n      } // remove tool\n\n\n      cell.removeTool(cell.isEdge() ? 'edge-editor' : 'node-editor');\n      this.undelegateDocumentEvents();\n    }\n  }\n\n  onDblClick(e) {\n    e.stopPropagation();\n  }\n\n  onMouseDown(e) {\n    e.stopPropagation();\n  }\n\n  autoFocus() {\n    setTimeout(() => {\n      this.editor.focus();\n      this.selectText();\n    });\n  }\n\n  selectText() {\n    if (window.getSelection) {\n      const range = document.createRange();\n      const selection = window.getSelection();\n      range.selectNodeContents(this.editor);\n      selection.removeAllRanges();\n      selection.addRange(range);\n    }\n  }\n\n}\n\n(function (CellEditor) {\n  CellEditor.config({\n    tagName: 'div',\n    isSVGElement: false,\n    events: {\n      dblclick: 'onDblClick',\n      mousedown: 'onMouseDown'\n    },\n    documentEvents: {\n      mousedown: 'onDocumentMouseDown'\n    }\n  });\n})(CellEditor || (CellEditor = {}));\n\n(function (CellEditor) {\n  CellEditor.NodeEditor = CellEditor.define({\n    attrs: {\n      fontSize: 14,\n      fontFamily: 'Arial, helvetica, sans-serif',\n      color: '#000',\n      backgroundColor: '#fff'\n    },\n\n    getText({\n      cell\n    }) {\n      return cell.attr('text/text');\n    },\n\n    setText({\n      cell,\n      value\n    }) {\n      cell.attr('text/text', value);\n    }\n\n  });\n  CellEditor.EdgeEditor = CellEditor.define({\n    attrs: {\n      fontSize: 14,\n      fontFamily: 'Arial, helvetica, sans-serif',\n      color: '#000',\n      backgroundColor: '#fff'\n    },\n    labelAddable: true,\n\n    getText({\n      cell,\n      index\n    }) {\n      if (index === -1) {\n        return '';\n      }\n\n      return cell.prop(`labels/${index}/attrs/label/text`);\n    },\n\n    setText({\n      cell,\n      value,\n      index,\n      distance\n    }) {\n      const edge = cell;\n\n      if (index === -1) {\n        edge.appendLabel({\n          position: {\n            distance: distance\n          },\n          attrs: {\n            label: {\n              text: value\n            }\n          }\n        });\n      } else {\n        if (value) {\n          edge.prop(`labels/${index}/attrs/label/text`, value);\n        } else if (typeof index === 'number') {\n          edge.removeLabelAt(index);\n        }\n      }\n    }\n\n  });\n})(CellEditor || (CellEditor = {}));","map":{"version":3,"mappings":"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","names":["ToolsView","Point","Dom","FunctionExt","CellEditor","ToolItem","constructor","render","createElement","update","autoFocus","delegateDocumentEvents","options","documentEvents","cell","classNames","prefixClassName","isEdge","editor","addClass","contentEditable","container","appendChild","graph","style","pos","minWidth","isNode","getBBox","center","size","width","e","event","target","parent","parentElement","isEdgeLabel","hasClass","index","getAttribute","labelIndex","parseInt","matrix","translation","parseTransformString","tx","ty","labelAddable","clientToLocal","create","clientX","clientY","view","cellView","d","path","closestPointLength","distance","localToGraph","left","x","top","y","scale","transform","sx","sy","attrs","fontSize","fontFamily","color","backgroundColor","getText","text","call","innerText","onDocumentMouseDown","value","replace","setText","removeTool","undelegateDocumentEvents","onDblClick","stopPropagation","onMouseDown","setTimeout","focus","selectText","window","getSelection","range","document","createRange","selection","selectNodeContents","removeAllRanges","addRange","config","tagName","isSVGElement","events","dblclick","mousedown","define","attr","prop","edge","appendLabel","position","label","removeLabelAt"],"sourceRoot":"","sources":["../../../src/registry/tool/editor.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}