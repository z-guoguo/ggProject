{"ast":null,"code":"import { __extends } from \"tslib\";\nimport { detect } from 'detect-browser';\nimport Container from './container';\nimport { isBrowser, isNil, isString } from '../util/util';\nimport Timeline from '../animate/timeline';\nimport EventController from '../event/event-contoller';\nvar PX_SUFFIX = 'px';\nvar browser = detect();\nvar isFirefox = browser && browser.name === 'firefox';\n\nvar Canvas =\n/** @class */\nfunction (_super) {\n  __extends(Canvas, _super);\n\n  function Canvas(cfg) {\n    var _this = _super.call(this, cfg) || this;\n\n    _this.initContainer();\n\n    _this.initDom();\n\n    _this.initEvents();\n\n    _this.initTimeline();\n\n    return _this;\n  }\n\n  Canvas.prototype.getDefaultCfg = function () {\n    var cfg = _super.prototype.getDefaultCfg.call(this); // set default cursor style for canvas\n\n\n    cfg['cursor'] = 'default'; // CSS transform 目前尚未经过长时间验证，为了避免影响上层业务，默认关闭，上层按需开启\n\n    cfg['supportCSSTransform'] = false;\n    return cfg;\n  };\n  /**\n   * @protected\n   * 初始化容器\n   */\n\n\n  Canvas.prototype.initContainer = function () {\n    var container = this.get('container');\n\n    if (isString(container)) {\n      container = document.getElementById(container);\n      this.set('container', container);\n    }\n  };\n  /**\n   * @protected\n   * 初始化 DOM\n   */\n\n\n  Canvas.prototype.initDom = function () {\n    var el = this.createDom();\n    this.set('el', el); // 附加到容器\n\n    var container = this.get('container');\n    container.appendChild(el); // 设置初始宽度\n\n    this.setDOMSize(this.get('width'), this.get('height'));\n  };\n  /**\n   * @protected\n   * 初始化绑定的事件\n   */\n\n\n  Canvas.prototype.initEvents = function () {\n    var eventController = new EventController({\n      canvas: this\n    });\n    eventController.init();\n    this.set('eventController', eventController);\n  };\n  /**\n   * @protected\n   * 初始化时间轴\n   */\n\n\n  Canvas.prototype.initTimeline = function () {\n    var timeline = new Timeline(this);\n    this.set('timeline', timeline);\n  };\n  /**\n   * @protected\n   * 修改画布对应的 DOM 的大小\n   * @param {number} width  宽度\n   * @param {number} height 高度\n   */\n\n\n  Canvas.prototype.setDOMSize = function (width, height) {\n    var el = this.get('el');\n\n    if (isBrowser) {\n      el.style.width = width + PX_SUFFIX;\n      el.style.height = height + PX_SUFFIX;\n    }\n  }; // 实现接口\n\n\n  Canvas.prototype.changeSize = function (width, height) {\n    this.setDOMSize(width, height);\n    this.set('width', width);\n    this.set('height', height);\n    this.onCanvasChange('changeSize');\n  };\n  /**\n   * 获取当前的渲染引擎\n   * @return {Renderer} 返回当前的渲染引擎\n   */\n\n\n  Canvas.prototype.getRenderer = function () {\n    return this.get('renderer');\n  };\n  /**\n   * 获取画布的 cursor 样式\n   * @return {Cursor}\n   */\n\n\n  Canvas.prototype.getCursor = function () {\n    return this.get('cursor');\n  };\n  /**\n   * 设置画布的 cursor 样式\n   * @param {Cursor} cursor  cursor 样式\n   */\n\n\n  Canvas.prototype.setCursor = function (cursor) {\n    this.set('cursor', cursor);\n    var el = this.get('el');\n\n    if (isBrowser && el) {\n      // 直接设置样式，不等待鼠标移动时再设置\n      el.style.cursor = cursor;\n    }\n  }; // 实现接口\n\n\n  Canvas.prototype.getPointByEvent = function (ev) {\n    var supportCSSTransform = this.get('supportCSSTransform');\n\n    if (supportCSSTransform) {\n      // For Firefox <= 38\n      if (isFirefox && !isNil(ev.layerX) && ev.layerX !== ev.offsetX) {\n        return {\n          x: ev.layerX,\n          y: ev.layerY\n        };\n      }\n\n      if (!isNil(ev.offsetX)) {\n        // For IE6+, Firefox >= 39, Chrome, Safari, Opera\n        return {\n          x: ev.offsetX,\n          y: ev.offsetY\n        };\n      }\n    } // should calculate by self for other cases, like Safari in ios\n    // TODO: support CSS transform\n\n\n    var _a = this.getClientByEvent(ev),\n        clientX = _a.x,\n        clientY = _a.y;\n\n    return this.getPointByClient(clientX, clientY);\n  }; // 获取 touch 事件的 clientX 和 clientY 需要单独处理\n\n\n  Canvas.prototype.getClientByEvent = function (ev) {\n    var clientInfo = ev;\n\n    if (ev.touches) {\n      if (ev.type === 'touchend') {\n        clientInfo = ev.changedTouches[0];\n      } else {\n        clientInfo = ev.touches[0];\n      }\n    }\n\n    return {\n      x: clientInfo.clientX,\n      y: clientInfo.clientY\n    };\n  }; // 实现接口\n\n\n  Canvas.prototype.getPointByClient = function (clientX, clientY) {\n    var el = this.get('el');\n    var bbox = el.getBoundingClientRect();\n    return {\n      x: clientX - bbox.left,\n      y: clientY - bbox.top\n    };\n  }; // 实现接口\n\n\n  Canvas.prototype.getClientByPoint = function (x, y) {\n    var el = this.get('el');\n    var bbox = el.getBoundingClientRect();\n    return {\n      x: x + bbox.left,\n      y: y + bbox.top\n    };\n  }; // 实现接口\n\n\n  Canvas.prototype.draw = function () {};\n  /**\n   * @protected\n   * 销毁 DOM 容器\n   */\n\n\n  Canvas.prototype.removeDom = function () {\n    var el = this.get('el');\n    el.parentNode.removeChild(el);\n  };\n  /**\n   * @protected\n   * 清理所有的事件\n   */\n\n\n  Canvas.prototype.clearEvents = function () {\n    var eventController = this.get('eventController');\n    eventController.destroy();\n  };\n\n  Canvas.prototype.isCanvas = function () {\n    return true;\n  };\n\n  Canvas.prototype.getParent = function () {\n    return null;\n  };\n\n  Canvas.prototype.destroy = function () {\n    var timeline = this.get('timeline');\n\n    if (this.get('destroyed')) {\n      return;\n    }\n\n    this.clear(); // 同初始化时相反顺序调用\n\n    if (timeline) {\n      // 画布销毁时自动停止动画\n      timeline.stop();\n    }\n\n    this.clearEvents();\n    this.removeDom();\n\n    _super.prototype.destroy.call(this);\n  };\n\n  return Canvas;\n}(Container);\n\nexport default Canvas;","map":{"version":3,"mappings":"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","names":["detect","Container","isBrowser","isNil","isString","Timeline","EventController","PX_SUFFIX","browser","isFirefox","name","__extends","cfg","_super","_this","initContainer","initDom","initEvents","initTimeline","Canvas","getDefaultCfg","call","container","get","document","getElementById","set","el","createDom","appendChild","setDOMSize","eventController","canvas","init","timeline","width","height","style","onCanvasChange","cursor","ev","supportCSSTransform","layerX","offsetX","x","y","layerY","offsetY","getClientByEvent","clientX","clientY","getPointByClient","clientInfo","touches","type","changedTouches","bbox","getBoundingClientRect","left","top","parentNode","removeChild","destroy","clear","stop","clearEvents","removeDom"],"sourceRoot":"","sources":["../../src/abstract/canvas.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}