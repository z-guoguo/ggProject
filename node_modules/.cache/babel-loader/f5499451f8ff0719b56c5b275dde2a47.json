{"ast":null,"code":"\"use strict\"; // @ts-nocheck\n\n/**\n * @fileOverview fruchterman layout\n * @author shiwu.wyy@antfin.com\n */\n\nrequire(\"core-js/modules/es.error.cause.js\");\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.GForceGPULayout = void 0;\n\nvar base_1 = require(\"../base\");\n\nvar util_1 = require(\"../../util\"); // @ts-ignore\n\n\nvar g_webgpu_1 = require(\"@antv/g-webgpu\");\n\nvar gpu_1 = require(\"../../util/gpu\");\n\nvar math_1 = require(\"../../util/math\");\n\nvar gForceShader_1 = require(\"./gForceShader\");\n\nvar constants_1 = require(\"../constants\");\n/**\n * graphin 中的 force 布局\n */\n\n\nvar GForceGPULayout =\n/** @class */\nfunction (_super) {\n  __extends(GForceGPULayout, _super);\n\n  function GForceGPULayout(options) {\n    var _this = _super.call(this) || this;\n    /** 停止迭代的最大迭代数 */\n\n\n    _this.maxIteration = 1000;\n    /** 弹簧引力系数 */\n\n    _this.edgeStrength = 200;\n    /** 斥力系数 */\n\n    _this.nodeStrength = 1000;\n    /** 库伦系数 */\n\n    _this.coulombDisScale = 0.005;\n    /** 阻尼系数 */\n\n    _this.damping = 0.9;\n    /** 最大速度 */\n\n    _this.maxSpeed = 1000;\n    /** 一次迭代的平均移动距离小于该值时停止迭代 */\n\n    _this.minMovement = 0.5;\n    /** 迭代中衰减 */\n\n    _this.interval = 0.02;\n    /** 斥力的一个系数 */\n\n    _this.factor = 1;\n    /** 理想边长 */\n\n    _this.linkDistance = 1;\n    /** 重力大小 */\n\n    _this.gravity = 10;\n    /** 是否启用web worker。前提是在web worker里执行布局，否则无效\t*/\n\n    _this.workerEnabled = false;\n    _this.nodes = [];\n    _this.edges = [];\n    _this.width = 300;\n    _this.height = 300;\n    _this.nodeMap = {};\n    _this.nodeIdxMap = {};\n\n    _this.updateCfg(options);\n\n    return _this;\n  }\n\n  GForceGPULayout.prototype.getDefaultCfg = function () {\n    return {\n      maxIteration: 2000,\n      gravity: 10,\n      clustering: false,\n      clusterGravity: 10\n    };\n  };\n  /**\n   * 执行布局\n   */\n\n\n  GForceGPULayout.prototype.execute = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var self, nodes, center, nodeMap, nodeIdxMap;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            self = this;\n            nodes = self.nodes;\n\n            if (!nodes || nodes.length === 0) {\n              if (self.onLayoutEnd) self.onLayoutEnd();\n              return [2\n              /*return*/\n              ];\n            }\n\n            if (!self.width && typeof window !== \"undefined\") {\n              self.width = window.innerWidth;\n            }\n\n            if (!self.height && typeof window !== \"undefined\") {\n              self.height = window.innerHeight;\n            }\n\n            if (!self.center) {\n              self.center = [self.width / 2, self.height / 2];\n            }\n\n            center = self.center;\n\n            if (nodes.length === 1) {\n              nodes[0].x = center[0];\n              nodes[0].y = center[1];\n              if (self.onLayoutEnd) self.onLayoutEnd();\n              return [2\n              /*return*/\n              ];\n            }\n\n            nodeMap = {};\n            nodeIdxMap = {};\n            nodes.forEach(function (node, i) {\n              if (!(0, util_1.isNumber)(node.x)) node.x = Math.random() * self.width;\n              if (!(0, util_1.isNumber)(node.y)) node.y = Math.random() * self.height;\n              nodeMap[node.id] = node;\n              nodeIdxMap[node.id] = i;\n            });\n            self.nodeMap = nodeMap;\n            self.nodeIdxMap = nodeIdxMap;\n            self.nodeStrength = (0, gpu_1.proccessToFunc)(self.nodeStrength, 1);\n            self.edgeStrength = (0, gpu_1.proccessToFunc)(self.edgeStrength, 1); // layout\n\n            return [4\n            /*yield*/\n            , self.run()];\n\n          case 1:\n            // layout\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  GForceGPULayout.prototype.executeWithWorker = function (canvas, ctx) {\n    var self = this;\n    var nodes = self.nodes;\n    var center = self.center;\n\n    if (!nodes || nodes.length === 0) {\n      return;\n    }\n\n    if (nodes.length === 1) {\n      nodes[0].x = center[0];\n      nodes[0].y = center[1];\n      return;\n    }\n\n    var nodeMap = {};\n    var nodeIdxMap = {};\n    nodes.forEach(function (node, i) {\n      if (!(0, util_1.isNumber)(node.x)) node.x = Math.random() * self.width;\n      if (!(0, util_1.isNumber)(node.y)) node.y = Math.random() * self.height;\n      nodeMap[node.id] = node;\n      nodeIdxMap[node.id] = i;\n    });\n    self.nodeMap = nodeMap;\n    self.nodeIdxMap = nodeIdxMap;\n    self.nodeStrength = (0, gpu_1.proccessToFunc)(self.nodeStrength, 1);\n    self.edgeStrength = (0, gpu_1.proccessToFunc)(self.edgeStrength, 1); // layout\n\n    self.run(canvas, ctx);\n  };\n\n  GForceGPULayout.prototype.run = function (canvas, ctx) {\n    return __awaiter(this, void 0, void 0, function () {\n      var self, nodes, edges, maxIteration, numParticles, _a, maxEdgePerVetex, nodesEdgesArray, masses, nodeStrengths, centerXs, centerYs, centerGravities, fxs, fys, gravity, center, nodeAttributeArray1, nodeAttributeArray2, workerEnabled, world, onLayoutEnd, initPreviousData, i, kernelGForce, kernelAveMovement, execute;\n\n      var _this = this;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            self = this;\n            nodes = self.nodes;\n            edges = self.edges;\n            maxIteration = self.maxIteration;\n\n            if (!self.width && typeof window !== \"undefined\") {\n              self.width = window.innerWidth;\n            }\n\n            if (!self.height && typeof window !== \"undefined\") {\n              self.height = window.innerHeight;\n            }\n\n            numParticles = nodes.length;\n            self.linkDistance = (0, gpu_1.proccessToFunc)(self.linkDistance);\n            self.edgeStrength = (0, gpu_1.proccessToFunc)(self.edgeStrength);\n            _a = (0, gpu_1.buildTextureDataWithTwoEdgeAttr)(nodes, edges, self.linkDistance, self.edgeStrength), maxEdgePerVetex = _a.maxEdgePerVetex, nodesEdgesArray = _a.array; // init degree for mass\n\n            self.degrees = (0, math_1.getDegree)(nodes.length, self.nodeIdxMap, edges);\n            masses = [];\n            nodeStrengths = [];\n            centerXs = [];\n            centerYs = [];\n            centerGravities = [];\n            fxs = [];\n            fys = [];\n\n            if (!self.getMass) {\n              self.getMass = function (d) {\n                return self.degrees[self.nodeIdxMap[d.id]] || 1;\n              };\n            }\n\n            gravity = self.gravity;\n            center = self.center;\n            nodes.forEach(function (node, i) {\n              masses.push(self.getMass(node));\n              nodeStrengths.push(self.nodeStrength(node));\n              if (!self.degrees[i]) self.degrees[i] = 0;\n              var nodeGravity = [center[0], center[1], gravity];\n\n              if (self.getCenter) {\n                var customCenter = self.getCenter(node, self.degrees[i]);\n\n                if (customCenter && (0, util_1.isNumber)(customCenter[0]) && (0, util_1.isNumber)(customCenter[1]) && (0, util_1.isNumber)(customCenter[2])) {\n                  nodeGravity = customCenter;\n                }\n              }\n\n              centerXs.push(nodeGravity[0]);\n              centerYs.push(nodeGravity[1]);\n              centerGravities.push(nodeGravity[2]);\n\n              if ((0, util_1.isNumber)(node.fx) && (0, util_1.isNumber)(node.fy)) {\n                fxs.push(node.fx || 0.001);\n                fys.push(node.fy || 0.001);\n              } else {\n                fxs.push(0);\n                fys.push(0);\n              }\n            });\n            nodeAttributeArray1 = (0, gpu_1.arrayToTextureData)([masses, self.degrees, nodeStrengths, fxs]);\n            nodeAttributeArray2 = (0, gpu_1.arrayToTextureData)([centerXs, centerYs, centerGravities, fys]);\n            workerEnabled = self.workerEnabled;\n\n            if (workerEnabled) {\n              world = g_webgpu_1.World.create({\n                canvas: canvas,\n                engineOptions: {\n                  supportCompute: true\n                }\n              });\n            } else {\n              world = g_webgpu_1.World.create({\n                engineOptions: {\n                  supportCompute: true\n                }\n              });\n            }\n\n            onLayoutEnd = self.onLayoutEnd;\n            initPreviousData = [];\n            nodesEdgesArray.forEach(function (value) {\n              initPreviousData.push(value);\n            });\n\n            for (i = 0; i < 4; i++) {\n              initPreviousData.push(0);\n            }\n\n            kernelGForce = world.createKernel(gForceShader_1.gForceBundle).setDispatch([numParticles, 1, 1]).setBinding({\n              u_Data: nodesEdgesArray,\n              u_damping: self.damping,\n              u_maxSpeed: self.maxSpeed,\n              u_minMovement: self.minMovement,\n              u_coulombDisScale: self.coulombDisScale,\n              u_factor: self.factor,\n              u_NodeAttributeArray1: nodeAttributeArray1,\n              u_NodeAttributeArray2: nodeAttributeArray2,\n              MAX_EDGE_PER_VERTEX: maxEdgePerVetex,\n              VERTEX_COUNT: numParticles,\n              u_AveMovement: initPreviousData,\n              u_interval: self.interval // 每次迭代更新，首次设置为 interval，在 onIterationCompleted 中更新\n\n            });\n            kernelAveMovement = world.createKernel(gForceShader_1.aveMovementBundle).setDispatch([1, 1, 1]).setBinding({\n              u_Data: nodesEdgesArray,\n              VERTEX_COUNT: numParticles,\n              u_AveMovement: [0, 0, 0, 0]\n            });\n\n            execute = function () {\n              return __awaiter(_this, void 0, void 0, function () {\n                var i, stepInterval, finalParticleData;\n                return __generator(this, function (_a) {\n                  switch (_a.label) {\n                    case 0:\n                      i = 0;\n                      _a.label = 1;\n\n                    case 1:\n                      if (!(i < maxIteration)) return [3\n                      /*break*/\n                      , 5]; // TODO: 似乎都来自 kernelGForce 是一个引用\n                      // 当前坐标作为下一次迭代的 PreviousData\n                      // if (i > 0) {\n                      //   kernelAveMovement.setBinding({\n                      //     u_PreviousData: kernelGForce\n                      //   });\n                      // }\n                      // eslint-disable-next-line no-await-in-loop\n\n                      return [4\n                      /*yield*/\n                      , kernelGForce.execute()];\n\n                    case 2:\n                      // TODO: 似乎都来自 kernelGForce 是一个引用\n                      // 当前坐标作为下一次迭代的 PreviousData\n                      // if (i > 0) {\n                      //   kernelAveMovement.setBinding({\n                      //     u_PreviousData: kernelGForce\n                      //   });\n                      // }\n                      // eslint-disable-next-line no-await-in-loop\n                      _a.sent(); // midRes = await kernelGForce.getOutput();\n                      // 每次迭代完成后\n                      // 计算平均位移，用于提前终止迭代\n\n\n                      kernelAveMovement.setBinding({\n                        u_Data: kernelGForce\n                      }); // eslint-disable-next-line no-await-in-loop\n\n                      return [4\n                      /*yield*/\n                      , kernelAveMovement.execute()];\n\n                    case 3:\n                      // eslint-disable-next-line no-await-in-loop\n                      _a.sent();\n\n                      stepInterval = Math.max(0.02, self.interval - i * 0.002);\n                      kernelGForce.setBinding({\n                        u_interval: stepInterval,\n                        u_AveMovement: kernelAveMovement\n                      });\n                      _a.label = 4;\n\n                    case 4:\n                      i++;\n                      return [3\n                      /*break*/\n                      , 1];\n\n                    case 5:\n                      return [4\n                      /*yield*/\n                      , kernelGForce.getOutput()];\n\n                    case 6:\n                      finalParticleData = _a.sent(); // 所有迭代完成后\n\n                      if (canvas) {\n                        // 传递数据给主线程\n                        ctx.postMessage({\n                          type: constants_1.LAYOUT_MESSAGE.GPUEND,\n                          vertexEdgeData: finalParticleData // edgeIndexBufferData,\n\n                        });\n                      } else {\n                        nodes.forEach(function (node, i) {\n                          var x = finalParticleData[4 * i];\n                          var y = finalParticleData[4 * i + 1];\n                          node.x = x;\n                          node.y = y;\n                        });\n                      }\n\n                      if (onLayoutEnd) onLayoutEnd();\n                      return [2\n                      /*return*/\n                      ];\n                  }\n                });\n              });\n            };\n\n            return [4\n            /*yield*/\n            , execute()];\n\n          case 1:\n            _b.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  GForceGPULayout.prototype.getType = function () {\n    return \"gForce-gpu\";\n  };\n\n  return GForceGPULayout;\n}(base_1.Base);\n\nexports.GForceGPULayout = GForceGPULayout;","map":{"version":3,"mappings":"cAAA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAYA;;AACA,mC,CACA;;;AACA;;AACA;;AAKA;;AACA;;AACA;AASA;;;;;AAGA;AAAA;AAAA;EAAqCA;;EA+DnC,yBAAYC,OAAZ,EAA4C;IAA5C,YACEC,qBAAO,IADT;IA3DA;;;IACOC,qBAAuB,IAAvB;IAEP;;IACOA,qBAA2D,GAA3D;IAEP;;IACOA,qBAA2D,IAA3D;IAEP;;IACOA,wBAA0B,KAA1B;IAEP;;IACOA,gBAAkB,GAAlB;IAEP;;IACOA,iBAAmB,IAAnB;IAEP;;IACOA,oBAAsB,GAAtB;IAEP;;IACOA,iBAAmB,IAAnB;IAEP;;IACOA,eAAiB,CAAjB;IAKP;;IACOA,qBAA2D,CAA3D;IAEP;;IACOA,gBAAkB,EAAlB;IAKP;;IACOA,sBAAyB,KAAzB;IAEAA,cAAmB,EAAnB;IAEAA,cAAgB,EAAhB;IAEAA,cAAgB,GAAhB;IAEAA,eAAiB,GAAjB;IAEAA,gBAAmB,EAAnB;IAEAA,mBAAuB,EAAvB;;IASLA,KAAI,CAACC,SAAL,CAAeH,OAAf;;;EACD;;EAEMI,0CAAP;IACE,OAAO;MACLC,YAAY,EAAE,IADT;MAELC,OAAO,EAAE,EAFJ;MAGLC,UAAU,EAAE,KAHP;MAILC,cAAc,EAAE;IAJX,CAAP;EAMD,CAPM;EASP;;;;;EAGaJ,oCAAb;;;;;;YACQK,IAAI,GAAG,IAAP;YACAC,KAAK,GAAGD,IAAI,CAACC,KAAb;;YAEN,IAAI,CAACA,KAAD,IAAUA,KAAK,CAACC,MAAN,KAAiB,CAA/B,EAAkC;cAChC,IAAIF,IAAI,CAACG,WAAT,EAAsBH,IAAI,CAACG,WAAL;cACtB;cAAA;cAAA;YACD;;YAED,IAAI,CAACH,IAAI,CAACI,KAAN,IAAe,OAAOC,MAAP,KAAkB,WAArC,EAAkD;cAChDL,IAAI,CAACI,KAAL,GAAaC,MAAM,CAACC,UAApB;YACD;;YACD,IAAI,CAACN,IAAI,CAACO,MAAN,IAAgB,OAAOF,MAAP,KAAkB,WAAtC,EAAmD;cACjDL,IAAI,CAACO,MAAL,GAAcF,MAAM,CAACG,WAArB;YACD;;YACD,IAAI,CAACR,IAAI,CAACS,MAAV,EAAkB;cAChBT,IAAI,CAACS,MAAL,GAAc,CAACT,IAAI,CAACI,KAAL,GAAa,CAAd,EAAiBJ,IAAI,CAACO,MAAL,GAAc,CAA/B,CAAd;YACD;;YACKE,MAAM,GAAGT,IAAI,CAACS,MAAd;;YAEN,IAAIR,KAAK,CAACC,MAAN,KAAiB,CAArB,EAAwB;cACtBD,KAAK,CAAC,CAAD,CAAL,CAASS,CAAT,GAAaD,MAAM,CAAC,CAAD,CAAnB;cACAR,KAAK,CAAC,CAAD,CAAL,CAASU,CAAT,GAAaF,MAAM,CAAC,CAAD,CAAnB;cACA,IAAIT,IAAI,CAACG,WAAT,EAAsBH,IAAI,CAACG,WAAL;cACtB;cAAA;cAAA;YACD;;YACKS,OAAO,GAAY,EAAnB;YACAC,UAAU,GAAa,EAAvB;YACNZ,KAAK,CAACa,OAAN,CAAc,UAACC,IAAD,EAAOC,CAAP,EAAQ;cACpB,IAAI,CAAC,qBAASD,IAAI,CAACL,CAAd,CAAL,EAAuBK,IAAI,CAACL,CAAL,GAASO,IAAI,CAACC,MAAL,KAAgBlB,IAAI,CAACI,KAA9B;cACvB,IAAI,CAAC,qBAASW,IAAI,CAACJ,CAAd,CAAL,EAAuBI,IAAI,CAACJ,CAAL,GAASM,IAAI,CAACC,MAAL,KAAgBlB,IAAI,CAACO,MAA9B;cACvBK,OAAO,CAACG,IAAI,CAACI,EAAN,CAAP,GAAmBJ,IAAnB;cACAF,UAAU,CAACE,IAAI,CAACI,EAAN,CAAV,GAAsBH,CAAtB;YACD,CALD;YAMAhB,IAAI,CAACY,OAAL,GAAeA,OAAf;YACAZ,IAAI,CAACa,UAAL,GAAkBA,UAAlB;YAEAb,IAAI,CAACoB,YAAL,GAAoB,0BAAepB,IAAI,CAACoB,YAApB,EAAkC,CAAlC,CAApB;YACApB,IAAI,CAACqB,YAAL,GAAoB,0BAAerB,IAAI,CAACqB,YAApB,EAAkC,CAAlC,CAApB,EAEA;;YACA;YAAA;YAAA,EAAMrB,IAAI,CAACsB,GAAL,EAAN;;;YADA;YACAC;;;;;;;;EACD,CA1CY;;EA4CN5B,8CAAP,UAAyB6B,MAAzB,EAAqDC,GAArD,EAA8D;IAC5D,IAAMzB,IAAI,GAAG,IAAb;IACA,IAAMC,KAAK,GAAGD,IAAI,CAACC,KAAnB;IACA,IAAMQ,MAAM,GAAGT,IAAI,CAACS,MAApB;;IAEA,IAAI,CAACR,KAAD,IAAUA,KAAK,CAACC,MAAN,KAAiB,CAA/B,EAAkC;MAChC;IACD;;IACD,IAAID,KAAK,CAACC,MAAN,KAAiB,CAArB,EAAwB;MACtBD,KAAK,CAAC,CAAD,CAAL,CAASS,CAAT,GAAaD,MAAM,CAAC,CAAD,CAAnB;MACAR,KAAK,CAAC,CAAD,CAAL,CAASU,CAAT,GAAaF,MAAM,CAAC,CAAD,CAAnB;MACA;IACD;;IACD,IAAMG,OAAO,GAAY,EAAzB;IACA,IAAMC,UAAU,GAAa,EAA7B;IACAZ,KAAK,CAACa,OAAN,CAAc,UAACC,IAAD,EAAOC,CAAP,EAAQ;MACpB,IAAI,CAAC,qBAASD,IAAI,CAACL,CAAd,CAAL,EAAuBK,IAAI,CAACL,CAAL,GAASO,IAAI,CAACC,MAAL,KAAgBlB,IAAI,CAACI,KAA9B;MACvB,IAAI,CAAC,qBAASW,IAAI,CAACJ,CAAd,CAAL,EAAuBI,IAAI,CAACJ,CAAL,GAASM,IAAI,CAACC,MAAL,KAAgBlB,IAAI,CAACO,MAA9B;MACvBK,OAAO,CAACG,IAAI,CAACI,EAAN,CAAP,GAAmBJ,IAAnB;MACAF,UAAU,CAACE,IAAI,CAACI,EAAN,CAAV,GAAsBH,CAAtB;IACD,CALD;IAMAhB,IAAI,CAACY,OAAL,GAAeA,OAAf;IACAZ,IAAI,CAACa,UAAL,GAAkBA,UAAlB;IAEAb,IAAI,CAACoB,YAAL,GAAoB,0BAAepB,IAAI,CAACoB,YAApB,EAAkC,CAAlC,CAApB;IACApB,IAAI,CAACqB,YAAL,GAAoB,0BAAerB,IAAI,CAACqB,YAApB,EAAkC,CAAlC,CAApB,CAzB4D,CA2B5D;;IACArB,IAAI,CAACsB,GAAL,CAASE,MAAT,EAAiBC,GAAjB;EACD,CA7BM;;EA+BM9B,gCAAb,UAAiB6B,MAAjB,EAA6CC,GAA7C,EAAsD;;;;;;;;;YAC9CzB,IAAI,GAAG,IAAP;YACAC,KAAK,GAAGD,IAAI,CAACC,KAAb;YACAyB,KAAK,GAAG1B,IAAI,CAAC0B,KAAb;YACA9B,YAAY,GAAGI,IAAI,CAACJ,YAApB;;YACN,IAAI,CAACI,IAAI,CAACI,KAAN,IAAe,OAAOC,MAAP,KAAkB,WAArC,EAAkD;cAChDL,IAAI,CAACI,KAAL,GAAaC,MAAM,CAACC,UAApB;YACD;;YACD,IAAI,CAACN,IAAI,CAACO,MAAN,IAAgB,OAAOF,MAAP,KAAkB,WAAtC,EAAmD;cACjDL,IAAI,CAACO,MAAL,GAAcF,MAAM,CAACG,WAArB;YACD;;YAEKmB,YAAY,GAAG1B,KAAK,CAACC,MAArB;YAENF,IAAI,CAAC4B,YAAL,GAAoB,0BAAe5B,IAAI,CAAC4B,YAApB,CAApB;YAGA5B,IAAI,CAACqB,YAAL,GAAoB,0BAAerB,IAAI,CAACqB,YAApB,CAApB;YAGME,KAGF,2CACFtB,KADE,EAEFyB,KAFE,EAGF1B,IAAI,CAAC4B,YAHH,EAIF5B,IAAI,CAACqB,YAJH,CAHE,EACJQ,eAAe,qBADX,EAEGC,eAAe,WAFlB,EAUN;;YACA9B,IAAI,CAAC+B,OAAL,GAAe,sBAAU9B,KAAK,CAACC,MAAhB,EAAwBF,IAAI,CAACa,UAA7B,EAAyCa,KAAzC,CAAf;YACMM,MAAM,GAAa,EAAnB;YACAC,aAAa,GAAa,EAA1B;YACAC,QAAQ,GAAa,EAArB;YACAC,QAAQ,GAAa,EAArB;YACAC,eAAe,GAAa,EAA5B;YACAC,GAAG,GAAa,EAAhB;YACAC,GAAG,GAAa,EAAhB;;YAEN,IAAI,CAACtC,IAAI,CAACuC,OAAV,EAAmB;cACjBvC,IAAI,CAACuC,OAAL,GAAe,UAACC,CAAD,EAAE;gBACf,OAAOxC,IAAI,CAAC+B,OAAL,CAAa/B,IAAI,CAACa,UAAL,CAAgB2B,CAAC,CAACrB,EAAlB,CAAb,KAAuC,CAA9C;cACD,CAFD;YAGD;;YACKtB,OAAO,GAAGG,IAAI,CAACH,OAAf;YACAY,MAAM,GAAGT,IAAI,CAACS,MAAd;YACNR,KAAK,CAACa,OAAN,CAAc,UAACC,IAAD,EAAOC,CAAP,EAAQ;cACpBgB,MAAM,CAACS,IAAP,CAAazC,IAAI,CAACuC,OAAL,CAAqCxB,IAArC,CAAb;cACAkB,aAAa,CAACQ,IAAd,CAAoBzC,IAAI,CAACoB,YAAL,CAA+BL,IAA/B,CAApB;cACA,IAAI,CAACf,IAAI,CAAC+B,OAAL,CAAaf,CAAb,CAAL,EAAsBhB,IAAI,CAAC+B,OAAL,CAAaf,CAAb,IAAkB,CAAlB;cACtB,IAAI0B,WAAW,GAAG,CAACjC,MAAM,CAAC,CAAD,CAAP,EAAYA,MAAM,CAAC,CAAD,CAAlB,EAAuBZ,OAAvB,CAAlB;;cACA,IAAIG,IAAI,CAAC2C,SAAT,EAAoB;gBAClB,IAAMC,YAAY,GAAG5C,IAAI,CAAC2C,SAAL,CAAe5B,IAAf,EAAqBf,IAAI,CAAC+B,OAAL,CAAaf,CAAb,CAArB,CAArB;;gBACA,IACE4B,YAAY,IACZ,qBAASA,YAAY,CAAC,CAAD,CAArB,CADA,IAEA,qBAASA,YAAY,CAAC,CAAD,CAArB,CAFA,IAGA,qBAASA,YAAY,CAAC,CAAD,CAArB,CAJF,EAKE;kBACAF,WAAW,GAAGE,YAAd;gBACD;cACF;;cACDV,QAAQ,CAACO,IAAT,CAAcC,WAAW,CAAC,CAAD,CAAzB;cACAP,QAAQ,CAACM,IAAT,CAAcC,WAAW,CAAC,CAAD,CAAzB;cACAN,eAAe,CAACK,IAAhB,CAAqBC,WAAW,CAAC,CAAD,CAAhC;;cACA,IAAI,qBAAS3B,IAAI,CAAC8B,EAAd,KAAqB,qBAAS9B,IAAI,CAAC+B,EAAd,CAAzB,EAA4C;gBAC1CT,GAAG,CAACI,IAAJ,CAAS1B,IAAI,CAAC8B,EAAL,IAAW,KAApB;gBACAP,GAAG,CAACG,IAAJ,CAAS1B,IAAI,CAAC+B,EAAL,IAAW,KAApB;cACD,CAHD,MAGO;gBACLT,GAAG,CAACI,IAAJ,CAAS,CAAT;gBACAH,GAAG,CAACG,IAAJ,CAAS,CAAT;cACD;YACF,CA1BD;YA6BMM,mBAAmB,GAAG,8BAAmB,CAC7Cf,MAD6C,EAE7ChC,IAAI,CAAC+B,OAFwC,EAG7CE,aAH6C,EAI7CI,GAJ6C,CAAnB,CAAtB;YAOAW,mBAAmB,GAAG,8BAAmB,CAC7Cd,QAD6C,EAE7CC,QAF6C,EAG7CC,eAH6C,EAI7CE,GAJ6C,CAAnB,CAAtB;YAOAW,aAAa,GAAGjD,IAAI,CAACiD,aAArB;;YAGN,IAAIA,aAAJ,EAAmB;cACjBC,KAAK,GAAGC,iBAAMC,MAAN,CAAa;gBACnB5B,MAAM,QADa;gBAEnB6B,aAAa,EAAE;kBACbC,cAAc,EAAE;gBADH;cAFI,CAAb,CAAR;YAMD,CAPD,MAOO;cACLJ,KAAK,GAAGC,iBAAMC,MAAN,CAAa;gBACnBC,aAAa,EAAE;kBACbC,cAAc,EAAE;gBADH;cADI,CAAb,CAAR;YAKD;;YAOKnD,WAAW,GAAGH,IAAI,CAACG,WAAnB;YAEAoD,gBAAgB,GAAG,EAAnB;YACNzB,eAAe,CAAChB,OAAhB,CAAwB,UAAC0C,KAAD,EAAM;cAC5BD,gBAAgB,CAACd,IAAjB,CAAsBe,KAAtB;YACD,CAFD;;YAGA,KAASxC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,CAApB,EAAuBA,CAAC,EAAxB,EAA4B;cAC1BuC,gBAAgB,CAACd,IAAjB,CAAsB,CAAtB;YACD;;YAEKgB,YAAY,GAAGP,KAAK,CACvBQ,YADkB,CACLC,2BADK,EAElBC,WAFkB,CAEN,CAACjC,YAAD,EAAe,CAAf,EAAkB,CAAlB,CAFM,EAGlBkC,UAHkB,CAGP;cACVC,MAAM,EAAEhC,eADE;cAEViC,SAAS,EAAE/D,IAAI,CAACgE,OAFN;cAGVC,UAAU,EAAEjE,IAAI,CAACkE,QAHP;cAIVC,aAAa,EAAEnE,IAAI,CAACoE,WAJV;cAKVC,iBAAiB,EAAErE,IAAI,CAACsE,eALd;cAMVC,QAAQ,EAAEvE,IAAI,CAACwE,MANL;cAOVC,qBAAqB,EAAE1B,mBAPb;cAQV2B,qBAAqB,EAAE1B,mBARb;cASV2B,mBAAmB,EAAE9C,eATX;cAUV+C,YAAY,EAAEjD,YAVJ;cAWVkD,aAAa,EAAEtB,gBAXL;cAYVuB,UAAU,EAAE9E,IAAI,CAAC+E,QAZP,CAYgB;;YAZhB,CAHO,CAAf;YAqBAC,iBAAiB,GAAG9B,KAAK,CAC5BQ,YADuB,CACVC,gCADU,EAEvBC,WAFuB,CAEX,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAFW,EAGvBC,UAHuB,CAGZ;cACVC,MAAM,EAAEhC,eADE;cAEV8C,YAAY,EAAEjD,YAFJ;cAGVkD,aAAa,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV;YAHL,CAHY,CAApB;;YAWAI,OAAO,GAAG;cAAA;;;;;sBACLjE,CAAC,GAAG,CAAJ;;;;4BAAOA,CAAC,GAAGpB,eAAY;sBAAA;sBAAA,MAC9B;sBACA;sBACA;sBACA;sBACA;sBACA;sBACA;sBAEA;;sBACA;sBAAA;sBAAA,EAAM6D,YAAY,CAACwB,OAAb,EAAN;;;sBATA;sBACA;sBACA;sBACA;sBACA;sBACA;sBACA;sBAEA;sBACA1D,WAEA;sBAEA;sBACA;;;sBACAyD,iBAAiB,CAACnB,UAAlB,CAA6B;wBAC3BC,MAAM,EAAEL;sBADmB,CAA7B,GAIA;;sBACA;sBAAA;sBAAA,EAAMuB,iBAAiB,CAACC,OAAlB,EAAN;;;sBADA;sBACA1D;;sBAGM2D,YAAY,GAAGjE,IAAI,CAACkE,GAAL,CAAS,IAAT,EAAenF,IAAI,CAAC+E,QAAL,GAAgB/D,CAAC,GAAG,KAAnC,CAAf;sBACNyC,YAAY,CAACI,UAAb,CAAwB;wBACtBiB,UAAU,EAAEI,YADU;wBAEtBL,aAAa,EAAEG;sBAFO,CAAxB;;;;sBAzBgChE,CAAC;;;;;;sBA8BT;sBAAA;sBAAA,EAAMyC,YAAY,CAAC2B,SAAb,EAAN;;;sBAApBC,iBAAiB,GAAG9D,SAApB,EAEN;;sBACA,IAAIC,MAAJ,EAAY;wBACV;wBACAC,GAAG,CAAC6D,WAAJ,CAAgB;0BACdC,IAAI,EAAEC,2BAAeC,MADP;0BAEdC,cAAc,EAAEL,iBAFF,CAGd;;wBAHc,CAAhB;sBAKD,CAPD,MAOO;wBACLpF,KAAK,CAACa,OAAN,CAAc,UAACC,IAAD,EAAOC,CAAP,EAAQ;0BACpB,IAAMN,CAAC,GAAG2E,iBAAiB,CAAC,IAAIrE,CAAL,CAA3B;0BACA,IAAML,CAAC,GAAG0E,iBAAiB,CAAC,IAAIrE,CAAJ,GAAQ,CAAT,CAA3B;0BACAD,IAAI,CAACL,CAAL,GAASA,CAAT;0BACAK,IAAI,CAACJ,CAAL,GAASA,CAAT;wBACD,CALD;sBAMD;;sBAED,IAAIR,WAAJ,EAAiBA,WAAW;;;;;;eAlDd;YAmDf,CAnDK;;YAqDN;YAAA;YAAA,EAAM8E,OAAO,EAAb;;;YAAAU;;;;;;;;EACD,CAjNY;;EAmNNhG,oCAAP;IACE,OAAO,YAAP;EACD,CAFM;;EAGT;AAAC,CAjXD,CAAqCiG,WAArC;;AAAaC","names":["__extends","options","_super","_this","updateCfg","GForceGPULayout","maxIteration","gravity","clustering","clusterGravity","self","nodes","length","onLayoutEnd","width","window","innerWidth","height","innerHeight","center","x","y","nodeMap","nodeIdxMap","forEach","node","i","Math","random","id","nodeStrength","edgeStrength","run","_a","canvas","ctx","edges","numParticles","linkDistance","maxEdgePerVetex","nodesEdgesArray","degrees","masses","nodeStrengths","centerXs","centerYs","centerGravities","fxs","fys","getMass","d","push","nodeGravity","getCenter","customCenter","fx","fy","nodeAttributeArray1","nodeAttributeArray2","workerEnabled","world","g_webgpu_1","create","engineOptions","supportCompute","initPreviousData","value","kernelGForce","createKernel","gForceShader_1","setDispatch","setBinding","u_Data","u_damping","damping","u_maxSpeed","maxSpeed","u_minMovement","minMovement","u_coulombDisScale","coulombDisScale","u_factor","factor","u_NodeAttributeArray1","u_NodeAttributeArray2","MAX_EDGE_PER_VERTEX","VERTEX_COUNT","u_AveMovement","u_interval","interval","kernelAveMovement","execute","stepInterval","max","getOutput","finalParticleData","postMessage","type","constants_1","GPUEND","vertexEdgeData","_b","base_1","exports"],"sourceRoot":"","sources":["../../../src/layout/gpu/gForce.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}