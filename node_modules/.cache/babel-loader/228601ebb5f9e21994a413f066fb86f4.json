{"ast":null,"code":"import \"core-js/modules/es.error.cause.js\";\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nimport { ObjectExt } from '../util';\nimport { Rectangle } from '../geometry';\nimport { Background } from '../registry';\nimport { Base } from './base';\nexport class BackgroundManager extends Base {\n  get elem() {\n    return this.view.background;\n  }\n\n  init() {\n    this.startListening();\n\n    if (this.options.background) {\n      this.draw(this.options.background);\n    }\n  }\n\n  startListening() {\n    this.graph.on('scale', this.update, this);\n    this.graph.on('translate', this.update, this);\n  }\n\n  stopListening() {\n    this.graph.off('scale', this.update, this);\n    this.graph.off('translate', this.update, this);\n  }\n\n  updateBackgroundImage(options = {}) {\n    let backgroundSize = options.size || 'auto auto';\n    let backgroundPosition = options.position || 'center';\n    const scale = this.graph.transform.getScale();\n    const ts = this.graph.translate(); // backgroundPosition\n\n    if (typeof backgroundPosition === 'object') {\n      const x = ts.tx + scale.sx * (backgroundPosition.x || 0);\n      const y = ts.ty + scale.sy * (backgroundPosition.y || 0);\n      backgroundPosition = `${x}px ${y}px`;\n    } // backgroundSize\n\n\n    if (typeof backgroundSize === 'object') {\n      backgroundSize = Rectangle.fromSize(backgroundSize).scale(scale.sx, scale.sy);\n      backgroundSize = `${backgroundSize.width}px ${backgroundSize.height}px`;\n    }\n\n    this.elem.style.backgroundSize = backgroundSize;\n    this.elem.style.backgroundPosition = backgroundPosition;\n  }\n\n  drawBackgroundImage(img, options = {}) {\n    if (!(img instanceof HTMLImageElement)) {\n      this.elem.style.backgroundImage = '';\n      return;\n    } // draw multiple times to show the last image\n\n\n    const cache = this.optionsCache;\n\n    if (cache && cache.image !== options.image) {\n      return;\n    }\n\n    let uri;\n    const opacity = options.opacity;\n    const backgroundSize = options.size;\n    let backgroundRepeat = options.repeat || 'no-repeat';\n    const pattern = Background.registry.get(backgroundRepeat);\n\n    if (typeof pattern === 'function') {\n      const quality = options.quality || 1;\n      img.width *= quality;\n      img.height *= quality;\n      const canvas = pattern(img, options);\n\n      if (!(canvas instanceof HTMLCanvasElement)) {\n        throw new Error('Background pattern must return an HTML Canvas instance');\n      }\n\n      uri = canvas.toDataURL('image/png'); // `repeat` was changed in pattern function\n\n      if (options.repeat && backgroundRepeat !== options.repeat) {\n        backgroundRepeat = options.repeat;\n      } else {\n        backgroundRepeat = 'repeat';\n      }\n\n      if (typeof backgroundSize === 'object') {\n        // recalculate the tile size if an object passed in\n        backgroundSize.width *= canvas.width / img.width;\n        backgroundSize.height *= canvas.height / img.height;\n      } else if (backgroundSize === undefined) {\n        // calcule the tile size if no provided\n        options.size = {\n          width: canvas.width / quality,\n          height: canvas.height / quality\n        };\n      }\n    } else {\n      uri = img.src;\n\n      if (backgroundSize === undefined) {\n        options.size = {\n          width: img.width,\n          height: img.height\n        };\n      }\n    }\n\n    if (cache != null && typeof options.size === 'object' && options.image === cache.image && options.repeat === cache.repeat && options.quality === cache.quality) {\n      cache.size = ObjectExt.clone(options.size);\n    }\n\n    const style = this.elem.style;\n    style.backgroundImage = `url(${uri})`;\n    style.backgroundRepeat = backgroundRepeat;\n    style.opacity = opacity == null || opacity >= 1 ? '' : `${opacity}`;\n    this.updateBackgroundImage(options);\n  }\n\n  updateBackgroundColor(color) {\n    this.elem.style.backgroundColor = color || '';\n  }\n\n  updateBackgroundOptions(options) {\n    this.graph.options.background = options;\n  }\n\n  update() {\n    if (this.optionsCache) {\n      this.updateBackgroundImage(this.optionsCache);\n    }\n  }\n\n  draw(options) {\n    const opts = options || {};\n    this.updateBackgroundOptions(options);\n    this.updateBackgroundColor(opts.color);\n\n    if (opts.image) {\n      this.optionsCache = ObjectExt.clone(opts);\n      const img = document.createElement('img');\n\n      img.onload = () => this.drawBackgroundImage(img, options);\n\n      img.setAttribute('crossorigin', 'anonymous');\n      img.src = opts.image;\n    } else {\n      this.drawBackgroundImage(null);\n      this.optionsCache = null;\n    }\n  }\n\n  clear() {\n    this.draw();\n  }\n\n  dispose() {\n    this.clear();\n    this.stopListening();\n  }\n\n}\n\n__decorate([Base.dispose()], BackgroundManager.prototype, \"dispose\", null);","map":{"version":3,"mappings":"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","names":["ObjectExt","Rectangle","Background","Base","BackgroundManager","elem","view","background","init","startListening","options","draw","graph","on","update","stopListening","off","updateBackgroundImage","backgroundSize","size","backgroundPosition","position","scale","transform","getScale","ts","translate","x","tx","sx","y","ty","sy","fromSize","width","height","style","drawBackgroundImage","img","HTMLImageElement","backgroundImage","cache","optionsCache","image","uri","opacity","backgroundRepeat","repeat","pattern","registry","get","quality","canvas","HTMLCanvasElement","Error","toDataURL","undefined","src","clone","updateBackgroundColor","color","backgroundColor","updateBackgroundOptions","opts","document","createElement","onload","setAttribute","clear","dispose","__decorate"],"sourceRoot":"","sources":["../../src/graph/background.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}