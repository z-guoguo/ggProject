{"ast":null,"code":"import { __extends } from \"tslib\";\nimport { AbstractGroup } from '@antv/g-base';\nimport * as Shape from './shape';\nimport { applyAttrsToContext, drawChildren, refreshElement } from './util/draw';\nimport { each, max, min } from '@antv/util';\nimport { intersectRect } from './util/util';\n\nvar Group =\n/** @class */\nfunction (_super) {\n  __extends(Group, _super);\n\n  function Group() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n  /**\n   * 一些方法调用会引起画布变化\n   * @param {ChangeType} changeType 改变的类型\n   */\n\n\n  Group.prototype.onCanvasChange = function (changeType) {\n    refreshElement(this, changeType);\n  };\n\n  Group.prototype.getShapeBase = function () {\n    return Shape;\n  };\n\n  Group.prototype.getGroupBase = function () {\n    return Group;\n  }; // 同 shape 中的方法重复了\n\n\n  Group.prototype._applyClip = function (context, clip) {\n    if (clip) {\n      context.save(); // 将 clip 的属性挂载到 context 上\n\n      applyAttrsToContext(context, clip); // 绘制 clip 路径\n\n      clip.createPath(context);\n      context.restore(); // 裁剪\n\n      context.clip();\n\n      clip._afterDraw();\n    }\n  }; // 这个方法以前直接使用的 getCanvasBBox，由于 group 上没有缓存，所以每次重新计算，导致性能开销比较大\n  // 大概能够节省全局渲染 15-20% 的性能，如果不在这里加缓存优化后 10W 个节点无法达到 5-6 ms，大概能够 30-40ms\n\n\n  Group.prototype.cacheCanvasBBox = function () {\n    var children = this.cfg.children;\n    var xArr = [];\n    var yArr = [];\n    each(children, function (child) {\n      var bbox = child.cfg.cacheCanvasBBox; // isInview 的判定是一旦图形或者分组渲染就要计算是否在视图内，\n      // 这个判定 10W 个图形下差不多能够节省 5-6 ms 的开销\n\n      if (bbox && child.cfg.isInView) {\n        xArr.push(bbox.minX, bbox.maxX);\n        yArr.push(bbox.minY, bbox.maxY);\n      }\n    });\n    var bbox = null;\n\n    if (xArr.length) {\n      var minX = min(xArr);\n      var maxX = max(xArr);\n      var minY = min(yArr);\n      var maxY = max(yArr);\n      bbox = {\n        minX: minX,\n        minY: minY,\n        x: minX,\n        y: minY,\n        maxX: maxX,\n        maxY: maxY,\n        width: maxX - minX,\n        height: maxY - minY\n      };\n      var canvas = this.cfg.canvas;\n\n      if (canvas) {\n        var viewRange = canvas.getViewRange(); // 如果这个地方判定 isInView == false 设置 bbox 为 false 的话，拾取的性能会更高\n        // 但是目前 10W 图形的拾取在 2-5ms 内，这个优化意义不大，可以后期观察再看\n\n        this.set('isInView', intersectRect(bbox, viewRange));\n      }\n    } else {\n      this.set('isInView', false);\n    }\n\n    this.set('cacheCanvasBBox', bbox);\n  };\n\n  Group.prototype.draw = function (context, region) {\n    var children = this.cfg.children;\n    var allowDraw = region ? this.cfg.refresh : true; // 局部刷新需要判定\n    // 这个地方需要判定，在 G6 的场景每个 group 都有 transform 的场景下性能会开销非常大\n    // 通过 refresh 的判定，可以不刷新没有发生过变化的分组，不在视窗内的分组等等\n    // 如果想进一步提升局部渲染性能，可以进一步优化 refresh 的判定，依然有潜力\n\n    if (children.length && allowDraw) {\n      context.save(); // group 上的矩阵和属性也会应用到上下文上\n      // 先将 attrs 应用到上下文中，再设置 clip。因为 clip 应该被当前元素的 matrix 所影响\n\n      applyAttrsToContext(context, this);\n\n      this._applyClip(context, this.getClip());\n\n      drawChildren(context, children, region);\n      context.restore();\n      this.cacheCanvasBBox();\n    } // 这里的成本比较大，如果不绘制则不再\n    // this.set('cacheCanvasBBox', this.getCanvasBBox());\n\n\n    this.cfg.refresh = null; // 绘制后，消除更新标记\n\n    this.set('hasChanged', false);\n  }; // 绘制时被跳过，一般发生在分组隐藏时\n\n\n  Group.prototype.skipDraw = function () {\n    this.set('cacheCanvasBBox', null);\n    this.set('hasChanged', false);\n  };\n\n  return Group;\n}(AbstractGroup);\n\nexport default Group;","map":{"version":3,"mappings":"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","names":["AbstractGroup","Shape","applyAttrsToContext","drawChildren","refreshElement","each","max","min","intersectRect","__extends","Group","changeType","context","clip","save","createPath","restore","_afterDraw","children","cfg","xArr","yArr","child","bbox","cacheCanvasBBox","isInView","push","minX","maxX","minY","maxY","length","x","y","width","height","canvas","viewRange","getViewRange","set","region","allowDraw","refresh","_applyClip","getClip"],"sourceRoot":"","sources":["../src/group.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}