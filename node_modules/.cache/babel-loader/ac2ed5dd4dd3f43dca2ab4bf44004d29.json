{"ast":null,"code":"import { isAllowCapture, multiplyVec2, invert } from '@antv/g-base';\n\nfunction invertFromMatrix(v, matrix) {\n  if (matrix) {\n    var invertMatrix = invert(matrix);\n    return multiplyVec2(invertMatrix, v);\n  }\n\n  return v;\n}\n\nfunction getRefXY(element, x, y) {\n  // @ts-ignore\n  var totalMatrix = element.getTotalMatrix();\n\n  if (totalMatrix) {\n    var _a = invertFromMatrix([x, y, 1], totalMatrix),\n        refX = _a[0],\n        refY = _a[1];\n\n    return [refX, refY];\n  }\n\n  return [x, y];\n} // 拾取前的检测，只有通过检测才能继续拾取\n\n\nfunction preTest(element, x, y) {\n  // @ts-ignore\n  if (element.isCanvas && element.isCanvas()) {\n    return true;\n  } // 不允许被拾取，则返回 null\n  // @ts-ignore\n\n\n  if (!isAllowCapture(element) || element.cfg.isInView === false) {\n    return false;\n  }\n\n  if (element.cfg.clipShape) {\n    // 如果存在 clip\n    var _a = getRefXY(element, x, y),\n        refX = _a[0],\n        refY = _a[1];\n\n    if (element.isClipped(refX, refY)) {\n      return false;\n    }\n  } // @ts-ignore ，这个地方调用过于频繁\n\n\n  var bbox = element.cfg.cacheCanvasBBox || element.getCanvasBBox(); // 如果没有缓存 bbox，则说明不可见\n  // 注释掉的这段可能会加速拾取，上面的语句改写成 const bbox = element.cfg.cacheCanvasBBox;\n  // 这时候的拾取假设图形/分组在上一次绘制都在视窗内，但是上面已经判定了 isInView 所以意义不大\n  // 现在还调用 element.getCanvasBBox(); 一个很大的原因是便于单元测试\n  // if (!bbox) {\n  //   return false;\n  // }\n\n  if (!(x >= bbox.minX && x <= bbox.maxX && y >= bbox.minY && y <= bbox.maxY)) {\n    return false;\n  }\n\n  return true;\n} // 这个方法复写了 g-base 的 getShape\n\n\nexport function getShape(container, x, y) {\n  // 没有通过检测，则返回 null\n  if (!preTest(container, x, y)) {\n    return null;\n  }\n\n  var shape = null;\n  var children = container.getChildren();\n  var count = children.length;\n\n  for (var i = count - 1; i >= 0; i--) {\n    var child = children[i];\n\n    if (child.isGroup()) {\n      shape = getShape(child, x, y);\n    } else if (preTest(child, x, y)) {\n      var curShape = child;\n\n      var _a = getRefXY(child, x, y),\n          refX = _a[0],\n          refY = _a[1]; // @ts-ignore\n\n\n      if (curShape.isInShape(refX, refY)) {\n        shape = child;\n      }\n    }\n\n    if (shape) {\n      break;\n    }\n  }\n\n  return shape;\n}","map":{"version":3,"mappings":"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","names":["isAllowCapture","multiplyVec2","invert","invertFromMatrix","v","matrix","invertMatrix","getRefXY","element","x","y","totalMatrix","getTotalMatrix","refX","refY","preTest","isCanvas","cfg","isInView","clipShape","isClipped","bbox","cacheCanvasBBox","getCanvasBBox","minX","maxX","minY","maxY","getShape","container","shape","children","getChildren","count","length","i","child","isGroup","curShape","isInShape"],"sourceRoot":"","sources":["../../src/util/hit.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}