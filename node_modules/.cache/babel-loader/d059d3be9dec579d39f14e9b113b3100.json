{"ast":null,"code":"import \"core-js/modules/es.array.includes.js\";\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nimport Mousetrap from 'mousetrap';\nimport { Dom, FunctionExt } from '../util';\nimport { Disposable } from '../common';\nexport class Keyboard extends Disposable {\n  constructor(options) {\n    super();\n    this.options = options;\n    const scroller = this.graph.scroller.widget;\n    this.container = scroller ? scroller.container : this.graph.container;\n\n    if (options.global) {\n      this.target = document;\n    } else {\n      this.target = this.container;\n\n      if (!this.disabled) {\n        // ensure the container focusable\n        this.target.setAttribute('tabindex', '-1');\n      } // change to mouseup eventï¼Œprevent page stalling caused by focus\n\n\n      this.graph.on('cell:mouseup', this.focus, this);\n      this.graph.on('blank:mouseup', this.focus, this);\n    }\n\n    this.mousetrap = Keyboard.createMousetrap(this);\n  }\n\n  get graph() {\n    return this.options.graph;\n  }\n\n  get disabled() {\n    return this.options.enabled !== true;\n  }\n\n  enable() {\n    if (this.disabled) {\n      this.options.enabled = true;\n      this.graph.options.keyboard.enabled = true;\n\n      if (this.target instanceof HTMLElement) {\n        this.target.setAttribute('tabindex', '-1');\n      }\n    }\n  }\n\n  disable() {\n    if (!this.disabled) {\n      this.options.enabled = false;\n      this.graph.options.keyboard.enabled = false;\n\n      if (this.target instanceof HTMLElement) {\n        this.target.removeAttribute('tabindex');\n      }\n    }\n  }\n\n  on(keys, callback, action) {\n    this.mousetrap.bind(this.getKeys(keys), callback, action);\n  }\n\n  off(keys, action) {\n    this.mousetrap.unbind(this.getKeys(keys), action);\n  }\n\n  focus(e) {\n    const isInputEvent = this.isInputEvent(e.e);\n\n    if (isInputEvent) {\n      return;\n    }\n\n    const target = this.target;\n    target.focus({\n      preventScroll: true\n    });\n  }\n\n  getKeys(keys) {\n    return (Array.isArray(keys) ? keys : [keys]).map(key => this.formatkey(key));\n  }\n\n  formatkey(key) {\n    const formated = key.toLowerCase().replace(/\\s/g, '').replace('delete', 'del').replace('cmd', 'command');\n    const formatFn = this.options.format;\n\n    if (formatFn) {\n      return FunctionExt.call(formatFn, this.graph, formated);\n    }\n\n    return formated;\n  }\n\n  isGraphEvent(e) {\n    const target = e.srcElement || e.target;\n    const currentTarget = e.currentTarget;\n\n    if (target) {\n      if (target === this.target || currentTarget === this.target || target === document.body) {\n        return true;\n      }\n\n      return Dom.contains(this.container, target);\n    }\n\n    return false;\n  }\n\n  isInputEvent(e) {\n    const target = e.target;\n    const tagName = target && target.tagName.toLowerCase();\n    return ['input', 'textarea'].includes(tagName);\n  }\n\n  isEnabledForEvent(e) {\n    const allowed = !this.disabled && this.isGraphEvent(e);\n    const isInputEvent = this.isInputEvent(e);\n\n    if (allowed) {\n      const code = e.keyCode || e.which;\n\n      if (isInputEvent && (code === 8 || code === 46)) {\n        return false;\n      }\n\n      if (this.options.guard) {\n        return FunctionExt.call(this.options.guard, this.graph, e);\n      }\n    }\n\n    return allowed;\n  }\n\n  dispose() {\n    this.mousetrap.reset();\n  }\n\n}\n\n__decorate([Disposable.dispose()], Keyboard.prototype, \"dispose\", null);\n\n(function (Keyboard) {\n  function createMousetrap(keyboard) {\n    const mousetrap = new Mousetrap(keyboard.target);\n    const stopCallback = mousetrap.stopCallback;\n\n    mousetrap.stopCallback = (e, elem, combo) => {\n      if (keyboard.isEnabledForEvent(e)) {\n        if (stopCallback) {\n          return stopCallback.call(mousetrap, e, elem, combo);\n        }\n\n        return false;\n      }\n\n      return true;\n    };\n\n    return mousetrap;\n  }\n\n  Keyboard.createMousetrap = createMousetrap;\n})(Keyboard || (Keyboard = {}));","map":{"version":3,"mappings":"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","names":["Mousetrap","Dom","FunctionExt","Disposable","Keyboard","constructor","options","scroller","graph","widget","container","global","target","document","disabled","setAttribute","on","focus","mousetrap","createMousetrap","enabled","enable","keyboard","HTMLElement","disable","removeAttribute","keys","callback","action","bind","getKeys","off","unbind","e","isInputEvent","preventScroll","Array","isArray","map","key","formatkey","formated","toLowerCase","replace","formatFn","format","call","isGraphEvent","srcElement","currentTarget","body","contains","tagName","includes","isEnabledForEvent","allowed","code","keyCode","which","guard","dispose","reset","__decorate","stopCallback","elem","combo"],"sourceRoot":"","sources":["../../src/graph/keyboard.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}